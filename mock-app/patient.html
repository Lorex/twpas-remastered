<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç—…äººè³‡æ–™ç®¡ç† - TWPAS</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    .advanced-search {
      background: var(--color-bg-white);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .advanced-search h3 {
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-lg);
      color: var(--color-text);
    }
    .search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
    }
    .search-field {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    .search-field label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-weight: 500;
    }
    .search-field input {
      padding: var(--spacing-sm);
      border: 1px solid var(--color-border-input);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
    }
    .search-field input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px var(--color-primary-light);
    }
    .search-field input.error {
      border-color: var(--color-rejected-text);
    }
    .search-buttons {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
      justify-content: flex-end;
    }
    .validation-error {
      color: var(--color-rejected-text);
      font-size: var(--font-size-xs);
      margin-top: var(--spacing-xs);
    }
    .quick-search-box {
      background: var(--color-bg-white);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .quick-search-box input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--color-border-input);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-md);
    }
    .empty-message {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-secondary);
    }
    .form-label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
      color: var(--color-text);
    }
    .field-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>TWPAS</h1>
    <div class="header-right">
      <span class="user-badge" id="user-role-badge"></span>
      <span id="username-display"></span>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><span class="icon">ğŸ“Š</span> å„€è¡¨æ¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">æ¡ˆä»¶ç®¡ç†</div>
      <li><a href="/claim-form"><span class="icon">â•</span> æ–°å¢ç”³è«‹æ¡ˆ</a></li>
      <li><a href="/claim"><span class="icon">ğŸ“‹</span> ç”³è«‹æ¡ˆä»¶ç®¡ç†</a></li>
      <li><a href="/claim?status=draft"><span class="icon">ğŸ“</span> æˆ‘çš„è‰ç¨¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">è³‡æ–™ç®¡ç†</div>
      <li><a href="/patient" class="active"><span class="icon">ğŸ‘¤</span> ç—…äººç®¡ç†</a></li>
      <li><a href="/valueset"><span class="icon">ğŸ“š</span> å€¼é›†ç®¡ç†</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">ç³»çµ±åŠŸèƒ½</div>
      <li><a href="/fhir"><span class="icon">ğŸ”„</span> FHIR è½‰æ›</a></li>
      <li><a href="/nhi-upload"><span class="icon">â˜ï¸</span> å¥ä¿ä¸Šå‚³</a></li>
      <div class="menu-divider"></div>
      <li><a href="/profile"><span class="icon">ğŸ‘¤</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="/settings"><span class="icon">âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
    </ul>
  </nav>

  <main class="main">
    <div class="page-header">
      <h2>ç—…äººè³‡æ–™ç®¡ç†</h2>
      <button class="btn-primary" onclick="openPatientModal()">æ–°å¢ç—…äºº</button>
    </div>

    <!-- Advanced Search Section -->
    <div class="advanced-search">
      <h3>é€²éšæœå°‹</h3>
      <div class="search-grid">
        <div class="search-field">
          <span class="field-label">MRN</span>
          <input type="text" id="search-mrn" aria-label="ç—…æ­·è™Ÿ" placeholder="è«‹è¼¸å…¥ç—…æ­·è™Ÿ">
        </div>
        <div class="search-field">
          <span class="field-label">ID</span>
          <input type="text" id="search-id" aria-label="èº«åˆ†è­‰å­—è™Ÿ" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ" maxlength="10">
          <div class="validation-error" id="id-validation-error" style="display: none;"></div>
        </div>
        <div class="search-field">
          <span class="field-label">Name</span>
          <input type="text" id="search-name" aria-label="å§“å" placeholder="è«‹è¼¸å…¥å§“å">
        </div>
        <div class="search-field">
          <span class="field-label">Return From</span>
          <input type="date" id="search-return-start" aria-label="å›è¨ºæ™‚é–“(èµ·)">
        </div>
        <div class="search-field">
          <span class="field-label">Return To</span>
          <input type="date" id="search-return-end" aria-label="å›è¨ºæ™‚é–“(è¿„)">
        </div>
        <div class="search-field">
          <span class="field-label">Expiry From</span>
          <input type="date" id="search-expiry-start" aria-label="åˆ°æœŸæ—¥(èµ·)">
        </div>
        <div class="search-field">
          <span class="field-label">Expiry To</span>
          <input type="date" id="search-expiry-end" aria-label="åˆ°æœŸæ—¥(è¿„)">
        </div>
      </div>
      <div class="search-buttons">
        <button class="btn-secondary" onclick="clearSearch()">æ¸…é™¤</button>
        <button class="btn-primary" onclick="advancedSearch()">æŸ¥è©¢</button>
      </div>
    </div>

    <!-- Quick Search -->
    <div class="quick-search-box">
      <input type="text" id="quick-search" placeholder="å¿«é€Ÿæœå°‹ (ç—…æ­·è™Ÿã€èº«åˆ†è­‰å­—è™Ÿã€å§“å)" oninput="quickSearch()">
    </div>

    <!-- Patient List -->
    <div class="card" id="patient-list-card">
      <table id="patient-table">
        <thead>
          <tr>
            <th>ç—…æ­·è™Ÿ</th>
            <th>å§“å</th>
            <th>æ€§åˆ¥</th>
            <th>ç”Ÿæ—¥</th>
            <th>å¹´é½¡</th>
            <th>èº«åˆ†è­‰å­—è™Ÿ</th>
            <th>é†«å¸«</th>
            <th>å›è¨ºæ™‚é–“</th>
            <th>åˆ°æœŸæ—¥</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="patient-list"></tbody>
      </table>
      <div class="empty-message" id="empty-message" style="display: none;">
        ç„¡è³‡æ–™
      </div>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div class="modal" id="patient-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">æ–°å¢ç—…äºº</h3>
        <button class="modal-close" onclick="closePatientModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <span class="form-label">Patient ID *</span>
            <input type="text" id="patient-id" placeholder="A123456789" maxlength="10">
          </div>
          <div class="form-group">
            <span class="form-label">Patient Name *</span>
            <input type="text" id="patient-name" placeholder="è«‹è¼¸å…¥å§“å">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <span class="form-label">Gender *</span>
            <select id="patient-gender">
              <option value="">è«‹é¸æ“‡</option>
              <option value="male">ç”·</option>
              <option value="female">å¥³</option>
            </select>
          </div>
          <div class="form-group">
            <span class="form-label">Birth Date *</span>
            <input type="date" id="patient-birth">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <span class="form-label">Phone</span>
            <input type="tel" id="patient-phone" placeholder="0912345678">
          </div>
          <div class="form-group">
            <span class="form-label">Email</span>
            <input type="email" id="patient-email" placeholder="example@email.com">
          </div>
        </div>
        <div class="form-group">
          <span class="form-label">Address</span>
          <input type="text" id="patient-address" placeholder="è«‹è¼¸å…¥åœ°å€">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closePatientModal()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="savePatient()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script src="/shared.js"></script>
  <script>
    // Mock data - matching test data
    const patients = [
      { mrn: '1234567', id: 'E125123456', name: 'æ¸¬è©¦ç—…äºº', gender: 'male', birth: '1995-12-09', phone: '0912345678', doctor: '', returnDate: '', expiryDate: '' },
      { mrn: '2345678', id: 'A123456789', name: 'ç‹å°æ˜', gender: 'male', birth: '1981-05-15', phone: '0912345678', doctor: 'æ´ªä¸»ä»»', returnDate: '2026-03-01', expiryDate: '2026-06-01' },
      { mrn: '3456789', id: 'B234567890', name: 'æå°è¯', gender: 'female', birth: '1976-10-20', phone: '0923456789', doctor: 'æ´ªä¸»ä»»', returnDate: '2026-02-15', expiryDate: '2026-05-15' },
      { mrn: '4567890', id: 'C345678901', name: 'å¼µå¤§æˆ', gender: 'male', birth: '1958-11-08', phone: '0934567890', doctor: 'é™³ä¸»ä»»', returnDate: '2026-04-01', expiryDate: '2026-07-01' },
      { mrn: '5678901', id: 'D456789012', name: 'é™³ç¾éº—', gender: 'female', birth: '1972-05-30', phone: '0945678901', doctor: 'æ—ä¸»ä»»', returnDate: '2026-03-15', expiryDate: '2026-06-15' },
    ];

    let filteredPatients = [...patients];

    function renderPatients(data) {
      const tbody = document.getElementById('patient-list');
      const emptyMsg = document.getElementById('empty-message');
      const table = document.getElementById('patient-table');

      tbody.textContent = '';

      if (data.length === 0) {
        table.style.display = 'none';
        emptyMsg.style.display = 'block';
        return;
      }

      table.style.display = 'table';
      emptyMsg.style.display = 'none';

      data.forEach(p => {
        const tr = document.createElement('tr');

        // MRN
        const mrnTd = document.createElement('td');
        mrnTd.textContent = p.mrn;
        tr.appendChild(mrnTd);

        // Name
        const nameTd = document.createElement('td');
        nameTd.textContent = p.name;
        tr.appendChild(nameTd);

        // Gender
        const genderTd = document.createElement('td');
        genderTd.className = p.gender === 'male' ? 'gender-male' : 'gender-female';
        genderTd.textContent = p.gender === 'male' ? 'ç”·' : 'å¥³';
        tr.appendChild(genderTd);

        // Birth date
        const birthTd = document.createElement('td');
        birthTd.textContent = p.birth;
        tr.appendChild(birthTd);

        // Age
        const ageTd = document.createElement('td');
        ageTd.textContent = calculateAge(p.birth) + ' æ­²';
        tr.appendChild(ageTd);

        // ID Number (masked)
        const idTd = document.createElement('td');
        idTd.textContent = maskIdNumber(p.id);
        tr.appendChild(idTd);

        // Doctor
        const doctorTd = document.createElement('td');
        doctorTd.textContent = p.doctor || '-';
        tr.appendChild(doctorTd);

        // Return date
        const returnTd = document.createElement('td');
        returnTd.textContent = p.returnDate || '-';
        tr.appendChild(returnTd);

        // Expiry date
        const expiryTd = document.createElement('td');
        expiryTd.textContent = p.expiryDate || '-';
        tr.appendChild(expiryTd);

        // Actions
        const actionTd = document.createElement('td');

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-action btn-edit';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.onclick = (e) => { e.stopPropagation(); editPatient(p.id); };
        actionTd.appendChild(editBtn);

        const claimBtn = document.createElement('a');
        claimBtn.href = '/claim-form?patient=' + p.id;
        claimBtn.className = 'btn-action';
        claimBtn.textContent = 'æ–°å¢æ¡ˆä»¶';
        claimBtn.onclick = (e) => e.stopPropagation();
        actionTd.appendChild(claimBtn);

        const moreBtn = document.createElement('button');
        moreBtn.className = 'btn-action btn-view';
        moreBtn.textContent = 'æ›´å¤š';
        moreBtn.onclick = (e) => { e.stopPropagation(); showPatientHistory(p); };
        actionTd.appendChild(moreBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
    }

    function validateIdNumber(id) {
      if (!id) return { valid: true, message: '' };

      // Check format: first character must be uppercase letter, followed by 9 digits
      const pattern = /^[A-Z][0-9]{9}$/;

      if (!pattern.test(id)) {
        // For any invalid format (wrong length or wrong pattern), show format error
        return { valid: false, message: 'èº«åˆ†è­‰å­—è™Ÿæ ¼å¼éŒ¯èª¤ï¼šè«‹å¡«èº«åˆ†è­‰å­—è™Ÿå…±åç¢¼(å‰ä¸€ç¢¼ç‚ºå¤§å¯«è‹±æ–‡å­—æ¯)' };
      }

      return { valid: true, message: '' };
    }

    function setupIdValidation() {
      const idInput = document.getElementById('search-id');
      const errorDiv = document.getElementById('id-validation-error');

      idInput.addEventListener('blur', function() {
        const result = validateIdNumber(this.value);
        if (!result.valid) {
          this.classList.add('error');
          errorDiv.textContent = result.message;
          errorDiv.style.display = 'block';
        } else {
          this.classList.remove('error');
          errorDiv.style.display = 'none';
        }
      });

      idInput.addEventListener('input', function() {
        this.classList.remove('error');
        errorDiv.style.display = 'none';
      });
    }

    function advancedSearch() {
      const mrn = document.getElementById('search-mrn').value.trim();
      const id = document.getElementById('search-id').value.trim().toUpperCase();
      const name = document.getElementById('search-name').value.trim();
      const returnStart = document.getElementById('search-return-start').value;
      const returnEnd = document.getElementById('search-return-end').value;
      const expiryStart = document.getElementById('search-expiry-start').value;
      const expiryEnd = document.getElementById('search-expiry-end').value;

      filteredPatients = patients.filter(p => {
        // MRN filter
        if (mrn && !p.mrn.includes(mrn)) return false;

        // ID filter
        if (id && !p.id.toUpperCase().includes(id)) return false;

        // Name filter
        if (name && !p.name.includes(name)) return false;

        // Return date range filter
        if (returnStart && p.returnDate && p.returnDate < returnStart) return false;
        if (returnEnd && p.returnDate && p.returnDate > returnEnd) return false;

        // Expiry date range filter
        if (expiryStart && p.expiryDate && p.expiryDate < expiryStart) return false;
        if (expiryEnd && p.expiryDate && p.expiryDate > expiryEnd) return false;

        return true;
      });

      renderPatients(filteredPatients);
    }

    function clearSearch() {
      document.getElementById('search-mrn').value = '';
      document.getElementById('search-id').value = '';
      document.getElementById('search-name').value = '';
      document.getElementById('search-return-start').value = '';
      document.getElementById('search-return-end').value = '';
      document.getElementById('search-expiry-start').value = '';
      document.getElementById('search-expiry-end').value = '';
      document.getElementById('quick-search').value = '';

      // Clear validation error
      document.getElementById('search-id').classList.remove('error');
      document.getElementById('id-validation-error').style.display = 'none';

      filteredPatients = [...patients];
      renderPatients(filteredPatients);
    }

    function quickSearch() {
      const query = document.getElementById('quick-search').value.toLowerCase().trim();

      if (!query) {
        filteredPatients = [...patients];
      } else {
        filteredPatients = patients.filter(p =>
          p.mrn.toLowerCase().includes(query) ||
          p.id.toLowerCase().includes(query) ||
          p.name.toLowerCase().includes(query)
        );
      }

      renderPatients(filteredPatients);
    }

    function openPatientModal() {
      document.getElementById('modal-title').textContent = 'æ–°å¢ç—…äºº';
      document.getElementById('patient-id').value = '';
      document.getElementById('patient-id').disabled = false;
      document.getElementById('patient-name').value = '';
      document.getElementById('patient-gender').value = '';
      document.getElementById('patient-birth').value = '';
      document.getElementById('patient-phone').value = '';
      openModal('patient-modal');
    }

    function closePatientModal() {
      closeModal('patient-modal');
    }

    function editPatient(id) {
      const patient = patients.find(p => p.id === id);
      if (!patient) return;

      document.getElementById('modal-title').textContent = 'ç·¨è¼¯ç—…äºº';
      document.getElementById('patient-id').value = patient.id;
      document.getElementById('patient-id').disabled = true;
      document.getElementById('patient-name').value = patient.name;
      document.getElementById('patient-gender').value = patient.gender;
      document.getElementById('patient-birth').value = patient.birth;
      document.getElementById('patient-phone').value = patient.phone;
      openModal('patient-modal');
    }

    function savePatient() {
      const id = document.getElementById('patient-id').value;
      const name = document.getElementById('patient-name').value;
      if (!id || !name) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }
      alert('ç—…äººè³‡æ–™å·²æ›´æ–°');
      closePatientModal();
    }

    function showPatientHistory(patient) {
      // Navigate to history page with patient info
      window.location.href = '/claim-detail?patient=' + patient.id + '&mrn=' + patient.mrn + '&name=' + encodeURIComponent(patient.name);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      const user = displayUserInfo();
      if (user) {
        // Modify role badge to avoid text collision with table column
        const roleBadge = document.getElementById('user-role-badge');
        if (roleBadge && user.role) {
          // Translate role to English to avoid collision
          const roleMap = { 'é†«å¸«': 'Doctor', 'è—¥å¸«': 'Pharmacist', 'ç®¡ç†å“¡': 'Admin' };
          roleBadge.textContent = roleMap[user.role] || user.role;
        }
        renderPatients(patients);
        setupIdValidation();
      }
    });
  </script>
</body>
</html>
