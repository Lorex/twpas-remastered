<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢ç”³è«‹æ¡ˆ - TWPAS</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    /* Tabs styling */
    .form-tabs {
      display: flex;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--spacing-lg);
      background: var(--color-bg-white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      overflow-x: auto;
    }
    .form-tabs [role="tab"] {
      padding: var(--spacing-md) var(--spacing-lg);
      border: none;
      background: none;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-size: var(--font-size-base);
      white-space: nowrap;
      position: relative;
      transition: color 0.2s;
    }
    .form-tabs [role="tab"]:hover {
      color: var(--color-primary);
      background: var(--color-bg-hover);
    }
    .form-tabs [role="tab"][aria-selected="true"] {
      color: var(--color-primary);
      font-weight: 500;
    }
    .form-tabs [role="tab"][aria-selected="true"]::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--color-primary);
    }
    /* Tab panels */
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    /* Form sections */
    .form-section {
      background: var(--color-bg-white);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .form-section-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--color-border-light);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
    }
    .form-row-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .form-row-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    .required {
      color: var(--color-rejected-text);
    }
    /* Drug table */
    .drug-table {
      width: 100%;
      margin-top: var(--spacing-lg);
    }
    .drug-table th, .drug-table td {
      padding: var(--spacing-sm);
      text-align: left;
      border-bottom: 1px solid var(--color-border-light);
    }
    /* Button row */
    .btn-row {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
      margin-top: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--color-bg-white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }
    /* Info box */
    .info-box {
      background: var(--color-primary-light);
      border-left: 4px solid var(--color-primary);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-radius: var(--radius-sm);
    }
    .info-box ul {
      margin: var(--spacing-sm) 0 0 var(--spacing-lg);
    }
    /* Error messages */
    .error-message {
      color: var(--color-rejected-text);
      font-size: var(--font-size-sm);
      margin-top: var(--spacing-xs);
      display: none;
    }
    .error-message.show {
      display: block;
    }
    /* Success/Status messages */
    .status-message {
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-radius: var(--radius-sm);
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: var(--color-approved-bg);
      color: var(--color-approved-text);
    }
    .status-message.error {
      background: var(--color-rejected-bg);
      color: var(--color-rejected-text);
    }
    /* Original case field */
    .original-case-field {
      display: none;
    }
    .original-case-field.show {
      display: block;
    }
    /* ICD autocomplete */
    .icd-autocomplete {
      position: relative;
    }
    .icd-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--color-bg-white);
      border: 1px solid var(--color-border-input);
      border-radius: var(--radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .icd-suggestions.show {
      display: block;
    }
    .icd-suggestion-item {
      padding: var(--spacing-sm);
      cursor: pointer;
    }
    .icd-suggestion-item:hover {
      background: var(--color-bg-hover);
    }
    /* File upload */
    .file-upload-area {
      border: 2px dashed var(--color-border-input);
      padding: var(--spacing-xl);
      text-align: center;
      border-radius: var(--radius-md);
      cursor: pointer;
    }
    .file-upload-area:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }
    /* Notice list */
    .notice-list {
      list-style: none;
    }
    .notice-list li {
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    .notice-list li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>TWPAS ç™Œç—‡ç”¨è—¥äº‹å‰å¯©æŸ¥ç³»çµ±</h1>
    <div class="header-right">
      <span class="user-badge" id="user-role-badge"></span>
      <span id="username-display"></span>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><span class="icon">ğŸ“Š</span> å„€è¡¨æ¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">æ¡ˆä»¶ç®¡ç†</div>
      <li><a href="/claim-form" class="active"><span class="icon">â•</span> æ–°å¢ç”³è«‹æ¡ˆ</a></li>
      <li><a href="/claim"><span class="icon">ğŸ“‹</span> ç”³è«‹æ¡ˆä»¶ç®¡ç†</a></li>
      <li><a href="/claim?status=draft"><span class="icon">ğŸ“</span> æˆ‘çš„è‰ç¨¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">è³‡æ–™ç®¡ç†</div>
      <li><a href="/patient"><span class="icon">ğŸ‘¤</span> ç—…äººè³‡æ–™ç®¡ç†</a></li>
      <li><a href="/valueset"><span class="icon">ğŸ“š</span> å€¼é›†ç®¡ç†</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">ç³»çµ±åŠŸèƒ½</div>
      <li><a href="/fhir"><span class="icon">ğŸ”„</span> FHIR è½‰æ›</a></li>
      <li><a href="/nhi-upload"><span class="icon">â˜ï¸</span> å¥ä¿ä¸Šå‚³</a></li>
      <div class="menu-divider"></div>
      <li><a href="/profile"><span class="icon">ğŸ‘¤</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="/settings"><span class="icon">âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
    </ul>
  </nav>

  <main class="main">
    <div class="page-header">
      <h2>æ–°å¢ç”³è«‹æ¡ˆ</h2>
    </div>

    <!-- Status Message -->
    <div id="status-message" class="status-message">
      <span id="status-content"></span>
    </div>

    <!-- Drug cycle info box -->
    <div class="info-box">
      <strong>ç”¨è—¥ç”³è«‹é€±æœŸæç¤ºï¼š</strong>
      <ul>
        <li>æ—©æœŸä¹³ç™Œï¼š24é€±</li>
        <li>æ™šæœŸä¹³ç™Œï¼š18é€±</li>
        <li>Kadcylaï¼š12é€±</li>
      </ul>
    </div>

    <!-- Form Tabs -->
    <div class="form-tabs" role="tablist">
      <button role="tab" aria-selected="true" data-tab="medical-record" onclick="selectFormTab(this)">ç—…æ­·æ‘˜è¦</button>
      <button role="tab" aria-selected="false" data-tab="test-results" onclick="selectFormTab(this)">æª¢é©—çµæœ</button>
      <button role="tab" aria-selected="false" data-tab="attachment-summary" onclick="selectFormTab(this)">é™„ä»¶æ‘˜è¦</button>
      <button role="tab" aria-selected="false" data-tab="attachment-other" onclick="selectFormTab(this)">é™„ä»¶-å…¶ä»–</button>
      <button role="tab" aria-selected="false" data-tab="payment-rules" onclick="selectFormTab(this)">çµ¦ä»˜è¦å®š</button>
      <button role="tab" aria-selected="false" data-tab="supplementary" onclick="selectFormTab(this)">è£œå……é™„ä»¶</button>
    </div>

    <!-- Tab 1: ç—…æ­·æ‘˜è¦ -->
    <div id="medical-record" class="tab-panel active">
      <!-- Basic Info Section -->
      <div class="form-section">
        <div class="form-section-title">åŸºæœ¬è³‡æ–™</div>
        <div class="form-row form-row-4">
          <div class="form-group">
            <label for="visit-type">é–€è¨º/ä½é™¢ <span class="required">*</span></label>
            <select id="visit-type">
              <option value="">è«‹é¸æ“‡</option>
              <option value="é–€è¨º">é–€è¨º</option>
              <option value="ä½é™¢">ä½é™¢</option>
            </select>
          </div>
          <div class="form-group">
            <label for="patient-name">å§“å <span class="required">*</span></label>
            <input type="text" id="patient-name" placeholder="è«‹è¼¸å…¥ç—…äººå§“å">
          </div>
          <div class="form-group">
            <label for="id-number">èº«åˆ†è­‰å­—è™Ÿ <span class="required">*</span></label>
            <input type="text" id="id-number" placeholder="A123456789" maxlength="10">
            <div id="id-error" class="error-message">è«‹å¡«èº«åˆ†è­‰å­—è™Ÿå…±åç¢¼(å‰ä¸€ç¢¼ç‚ºå¤§å¯«è‹±æ–‡å­—æ¯)</div>
          </div>
          <div class="form-group">
            <label for="mrn">ç—…æ­·è™Ÿ <span class="required">*</span></label>
            <input type="text" id="mrn" placeholder="è«‹è¼¸å…¥ç—…æ­·è™Ÿ">
          </div>
        </div>
        <div class="form-row form-row-4">
          <div class="form-group">
            <label for="gender">æ€§åˆ¥ <span class="required">*</span></label>
            <input type="text" id="gender" placeholder="M / F" maxlength="1">
            <div id="gender-error" class="error-message">è«‹è¼¸å…¥ M / F</div>
          </div>
          <div class="form-group">
            <label for="birth-date">å‡ºç”Ÿå¹´æœˆæ—¥ <span class="required">*</span></label>
            <input type="date" id="birth-date" onchange="calculateAge()">
          </div>
          <div class="form-group">
            <label for="age">å¹´é½¡</label>
            <input type="text" id="age" readonly placeholder="è‡ªå‹•è¨ˆç®—">
          </div>
          <div class="form-group">
            <label for="apply-type">ç”³è«‹é¡åˆ¥ <span class="required">*</span></label>
            <select id="apply-type" onchange="handleApplyTypeChange()">
              <option value="">è«‹é¸æ“‡</option>
              <option value="é€æ ¸">é€æ ¸</option>
              <option value="è£œä»¶">è£œä»¶</option>
              <option value="ç”³å¾©">ç”³å¾©</option>
              <option value="çˆ­è­°å¯©è­°">çˆ­è­°å¯©è­°</option>
              <option value="è³‡æ–™ç•°å‹•">è³‡æ–™ç•°å‹•</option>
            </select>
          </div>
        </div>
        <div class="form-row form-row-4">
          <div class="form-group">
            <label for="patient-status">ç›®å‰ç—…æ‚£ç—…æ³ <span class="required">*</span></label>
            <select id="patient-status" onchange="handlePatientStatusChange()">
              <option value="">è«‹é¸æ“‡</option>
              <option value="å±€éƒ¨æ™šæœŸæ€§ç–¾ç—…">å±€éƒ¨æ™šæœŸæ€§ç–¾ç—…</option>
              <option value="è½‰ç§»æ€§ç–¾ç—…">è½‰ç§»æ€§ç–¾ç—…</option>
              <option value="æ—©æœŸç–¾ç—…">æ—©æœŸç–¾ç—…</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="form-group" id="other-status-group" style="display: none;">
            <label for="other-status-desc">å…¶ä»–ç—…æ³æè¿° <span class="required">*</span></label>
            <input type="text" id="other-status-desc" placeholder="è«‹æè¿°ç—…æ³">
          </div>
          <div class="form-group">
            <label for="apply-count">ç”³è«‹æ¬¡æ•¸ <span class="required">*</span></label>
            <input type="number" id="apply-count" min="1" value="1">
          </div>
          <div class="form-group original-case-field" id="original-case-group">
            <label for="original-case">åŸæ¡ˆä»¶ç·¨è™Ÿ</label>
            <input type="text" id="original-case" placeholder="è«‹è¼¸å…¥åŸç”³è«‹æ¡ˆä»¶ç·¨è™Ÿ">
          </div>
        </div>
      </div>

      <!-- ICD Code Section -->
      <div class="form-section">
        <div class="form-section-title">ç”³è«‹ç–¾ç—…åˆ¥</div>
        <div class="form-row">
          <div class="form-group icd-autocomplete">
            <label for="icd-search">ICD-10-CM ä»£ç¢¼æŸ¥è©¢</label>
            <input type="text" id="icd-search" placeholder="è¼¸å…¥ICDä»£ç¢¼æˆ–ç–¾ç—…ä»£ç¢¼" oninput="searchICD()">
            <div id="icd-suggestions" class="icd-suggestions" role="listbox"></div>
          </div>
          <div class="form-group">
            <label for="disease-code">ç”³è«‹ç–¾ç—…åˆ¥</label>
            <input type="text" id="disease-code" readonly placeholder="é¸æ“‡å¾Œè‡ªå‹•å¡«å…¥">
            <span id="disease-code-display" class="disease-display"></span>
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button class="btn-secondary" onclick="clearDiseaseCode()">ä¸€éµæ¸…ç©ºç”³è«‹ç–¾ç—…åˆ¥</button>
          </div>
        </div>
      </div>

      <!-- Drug Application Section -->
      <div class="form-section">
        <div class="form-section-title">ç”³è«‹å“é …</div>
        <div class="form-row form-row-4">
          <div class="form-group">
            <label for="weight">é«”é‡ (kg)</label>
            <input type="number" id="weight" placeholder="è«‹è¼¸å…¥é«”é‡">
          </div>
          <div class="form-group">
            <label for="drug-name">è—¥å“åç¨±åŠä»£ç¢¼ <span class="required">*</span></label>
            <select id="drug-name">
              <option value="">è«‹é¸æ“‡</option>
              <option value="Trastuzumab" label="Trastuzumab (Herceptin)">KC01065221 - Trastuzumab (Herceptin)</option>
              <option value="Kadcyla" label="Kadcyla (Ado-trastuzumab Emtansine)">KC01065222 - Kadcyla (Ado-trastuzumab Emtansine)</option>
              <option value="Perjeta" label="Perjeta (Pertuzumab)">KC01065223 - Perjeta (Pertuzumab)</option>
              <option value="Phesgo" label="Phesgo">KC01065224 - Phesgo</option>
            </select>
          </div>
          <div class="form-group">
            <label for="use-date-start">ä½¿ç”¨æ—¥æœŸèµ·</label>
            <input type="date" id="use-date-start">
          </div>
          <div class="form-group">
            <label for="use-date-end">ä½¿ç”¨æ—¥æœŸè¨–</label>
            <input type="date" id="use-date-end" onchange="validateDateRange()">
            <div id="date-error" class="error-message">ä½¿ç”¨æ—¥æœŸè¨–ä¸å¾—æ—©æ–¼ä½¿ç”¨æ—¥æœŸèµ·</div>
          </div>
        </div>
        <div class="form-row form-row-4">
          <div class="form-group">
            <label for="surgery-date">æ‰‹è¡“æ—¥æœŸ</label>
            <input type="date" id="surgery-date">
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button class="btn-primary" onclick="addDrugItem()">æ–°å¢</button>
          </div>
        </div>

        <!-- Drug Items Table -->
        <table class="drug-table">
          <thead>
            <tr>
              <th>è—¥å“åç¨±åŠä»£ç¢¼</th>
              <th>ç™‚ç¨‹åŠ‘é‡</th>
              <th>ç”³è«‹æ•¸é‡</th>
              <th>ä½¿ç”¨æ—¥æœŸèµ·</th>
              <th>ä½¿ç”¨æ—¥æœŸè¨–</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="drug-items"></tbody>
        </table>
      </div>

      <!-- Doctor Info Section -->
      <div class="form-section">
        <div class="form-section-title">ç”³è«‹é†«å¸«è³‡è¨Š</div>
        <div class="form-row">
          <div class="form-group">
            <label for="doctor-name">ç”³è«‹é†«å¸« <span class="required">*</span></label>
            <input type="text" id="doctor-name" value="æ´ªä¸»ä»»">
          </div>
          <div class="form-group">
            <label for="doctor-id">é†«å¸«èº«åˆ†è­‰</label>
            <input type="text" id="doctor-id" placeholder="è«‹è¼¸å…¥é†«å¸«èº«åˆ†è­‰å­—è™Ÿ">
          </div>
        </div>
      </div>

      <!-- Medical Description Section -->
      <div class="form-section">
        <div class="form-section-title">ç—…æ­·èªªæ˜</div>
        <div class="form-row">
          <div class="form-group">
            <label for="common-phrases">å¸¸ç”¨å­—</label>
            <select id="common-phrases" onchange="insertCommonPhrase()">
              <option value="">è«‹é¸æ“‡ç¯„æœ¬</option>
              <option value="ç—…äººè¨ºæ–·ç‚ºæ—©æœŸä¹³ç™Œ">æ—©æœŸä¹³ç™Œç¯„æœ¬</option>
              <option value="ç—…äººè¨ºæ–·ç‚ºæ™šæœŸä¹³ç™Œ">æ™šæœŸä¹³ç™Œç¯„æœ¬</option>
              <option value="ç—…äººè¨ºæ–·ç‚ºè½‰ç§»æ€§ä¹³ç™Œ">è½‰ç§»æ€§ä¹³ç™Œç¯„æœ¬</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="medical-description">ç—…æ­·èªªæ˜</label>
          <textarea id="medical-description" rows="6" placeholder="è«‹è¼¸å…¥è©³ç´°çš„ç—…æ­·æ‘˜è¦..."></textarea>
        </div>
      </div>
    </div>

    <!-- Tab 2: æª¢é©—çµæœ -->
    <div id="test-results" class="tab-panel">
      <div class="form-section">
        <div class="form-section-title">ä¸Šå‚³å€åŸŸ</div>
        <div class="form-row">
          <div class="form-group">
            <label for="test-category" id="test-category-label">å ±å‘Šé¡åˆ¥</label>
            <select id="test-category" aria-label="æª¢é©—çµæœé¡åˆ¥">
              <option value="">è«‹é¸æ“‡</option>
              <option value="é›»è…¦æ–·å±¤">é›»è…¦æ–·å±¤</option>
              <option value="è¶…éŸ³æ³¢æª¢æŸ¥">è¶…éŸ³æ³¢æª¢æŸ¥</option>
              <option value="æ ¸ç£å…±æŒ¯">æ ¸ç£å…±æŒ¯</option>
              <option value="ç—…ç†å ±å‘Š">ç—…ç†å ±å‘Š</option>
              <option value="åŸºå› æª¢æ¸¬">åŸºå› æª¢æ¸¬</option>
            </select>
          </div>
          <div class="form-group">
            <label for="test-date">æª¢æŸ¥æ—¥æœŸ</label>
            <input type="date" id="test-date">
          </div>
        </div>
        <div class="form-group">
          <label>ä¸Šå‚³æª”æ¡ˆ</label>
          <div class="file-upload-area" onclick="document.getElementById('test-file').click()">
            <p>é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆè‡³æ­¤è™•ä¸Šå‚³</p>
            <p>æ”¯æ´ PDF, JPG, PNG æ ¼å¼</p>
          </div>
          <input type="file" id="test-file" style="display: none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleTestFileUpload()">
          <div id="test-upload-status" class="status-message"></div>
        </div>

        <div class="form-section-title" style="margin-top: var(--spacing-xl);">å·²ä¸Šå‚³æª”æ¡ˆçµ±è¨ˆ</div>
        <table class="drug-table">
          <thead>
            <tr>
              <th>é¡åˆ¥</th>
              <th>å·²ä¸Šå‚³æ•¸é‡</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>é›»è…¦æ–·å±¤</td><td>0</td></tr>
            <tr><td>è¶…éŸ³æ³¢æª¢æŸ¥</td><td>0</td></tr>
            <tr><td>æ ¸ç£å…±æŒ¯</td><td>0</td></tr>
            <tr><td>ç—…ç†å ±å‘Š</td><td>0</td></tr>
            <tr><td>åŸºå› æª¢æ¸¬</td><td>0</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab 3: é™„ä»¶æ‘˜è¦ -->
    <div id="attachment-summary" class="tab-panel">
      <div class="form-section">
        <div class="form-section-title">ç—…æ‚£åŒæ„æ›¸</div>
        <div class="form-row">
          <div class="form-group">
            <label for="consent-date">åŒæ„æ›¸ç°½ç½²æ—¥æœŸ</label>
            <input type="date" id="consent-date">
          </div>
        </div>
        <div class="form-group">
          <label>ä¸Šå‚³ç—…æ‚£åŒæ„æ›¸</label>
          <div class="file-upload-area" onclick="document.getElementById('consent-file').click()">
            <p>é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆè‡³æ­¤è™•ä¸Šå‚³</p>
          </div>
          <input type="file" id="consent-file" style="display: none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleConsentFileUpload()">
          <div id="consent-upload-status" class="status-message"></div>
        </div>
      </div>
    </div>

    <!-- Tab 4: é™„ä»¶-å…¶ä»– -->
    <div id="attachment-other" class="tab-panel">
      <div class="form-section">
        <div class="form-section-title">å…¶ä»–é™„ä»¶</div>
        <div class="form-group">
          <label>ä¸Šå‚³å…¶ä»–é™„ä»¶</label>
          <div class="file-upload-area" onclick="document.getElementById('other-file').click()">
            <p>é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆè‡³æ­¤è™•ä¸Šå‚³</p>
          </div>
          <input type="file" id="other-file" style="display: none;" accept=".pdf,.jpg,.jpeg,.png">
        </div>
      </div>
    </div>

    <!-- Tab 5: çµ¦ä»˜è¦å®š -->
    <div id="payment-rules" class="tab-panel">
      <div class="form-section">
        <div class="form-section-title">æ³¨æ„äº‹é …</div>
        <ul class="notice-list">
          <li>1. æœ¬ç”³è«‹æ›¸é™ä¸€äººä¸€æ¡ˆï¼Œè«‹å‹¿é‡è¤‡ç”³è«‹ã€‚</li>
          <li>2. æ‡‰äº‹å‰å¯©æŸ¥ä¹‹é …ç›®æœªä¾è¦å®šäº‹å‰ç”³è«‹æ ¸å‡†è€…ï¼Œä¸äºˆçµ¦ä»˜ã€‚</li>
          <li>3. ç”³è«‹æ¡ˆä»¶éœ€æ–¼14æ—¥å…§å®Œæˆå¯©æ ¸ã€‚</li>
          <li>4. è£œä»¶æœŸé™ç‚ºæ”¶åˆ°è£œä»¶é€šçŸ¥å¾Œ7æ—¥å…§ã€‚</li>
          <li>5. ç”³å¾©æœŸé™ç‚ºæ”¶åˆ°å¯©æ ¸çµæœå¾Œ30æ—¥å…§ã€‚</li>
        </ul>
      </div>
      <div class="form-section">
        <div class="form-section-title">NHIè¦ç¯„</div>
        <p>ä¾æ“šå…¨æ°‘å¥åº·ä¿éšªè—¥å“è¦ç¯„ï¼Œæœ¬è—¥å“é©ç”¨æ–¼ä»¥ä¸‹æƒ…æ³ï¼š</p>
        <ul class="notice-list">
          <li>HER2 é™½æ€§æ—©æœŸä¹³ç™Œä¹‹è¼”åŠ©æ€§æ²»ç™‚</li>
          <li>HER2 é™½æ€§è½‰ç§»æ€§ä¹³ç™Œ</li>
          <li>HER2 é™½æ€§è½‰ç§»æ€§èƒƒç™Œ</li>
        </ul>
      </div>
    </div>

    <!-- Tab 6: è£œå……é™„ä»¶ -->
    <div id="supplementary" class="tab-panel">
      <div class="form-section">
        <div class="form-section-title">é¡å¤–è³‡æ–™</div>
        <div class="form-group">
          <label>ä¸Šå‚³å…¶ä»–è³‡æ–™</label>
          <div class="file-upload-area" onclick="document.getElementById('supplementary-file').click()">
            <p>é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆè‡³æ­¤è™•ä¸Šå‚³</p>
          </div>
          <input type="file" id="supplementary-file" style="display: none;" accept=".pdf,.jpg,.jpeg,.png">
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="btn-row">
      <button class="btn-secondary" onclick="window.location.href='/claim'">å–æ¶ˆ</button>
      <button class="btn-warning" onclick="saveDraft()">æš«æ™‚å„²å­˜ (è‰ç¨¿)</button>
      <button class="btn-primary" onclick="submitForReview()">ç¢ºèªé€å‡º (å¾…å¯©æ ¸)</button>
    </div>
  </main>

  <script src="/shared.js"></script>
  <script>
    // Form state
    var formData = {};
    var drugItems = [];

    // Tab selection
    function selectFormTab(tab) {
      document.querySelectorAll('.form-tabs [role="tab"]').forEach(function(t) {
        t.setAttribute('aria-selected', 'false');
      });
      tab.setAttribute('aria-selected', 'true');

      document.querySelectorAll('.tab-panel').forEach(function(p) {
        p.classList.remove('active');
      });
      document.getElementById(tab.dataset.tab).classList.add('active');
    }

    // Calculate age from birth date
    function calculateAge() {
      var birthDate = document.getElementById('birth-date').value;
      if (birthDate) {
        var age = calculateAge2(birthDate);
        document.getElementById('age').value = age + ' æ­²';
      }
    }

    function calculateAge2(birthDate) {
      var today = new Date();
      var birth = new Date(birthDate);
      var age = today.getFullYear() - birth.getFullYear();
      var m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    // Handle apply type change (show/hide original case field)
    function handleApplyTypeChange() {
      var applyType = document.getElementById('apply-type').value;
      var originalCaseGroup = document.getElementById('original-case-group');
      if (applyType === 'è£œä»¶' || applyType === 'ç”³å¾©' || applyType === 'çˆ­è­°å¯©è­°' || applyType === 'è³‡æ–™ç•°å‹•') {
        originalCaseGroup.classList.add('show');
      } else {
        originalCaseGroup.classList.remove('show');
      }
    }

    // Handle patient status change
    function handlePatientStatusChange() {
      var status = document.getElementById('patient-status').value;
      var otherGroup = document.getElementById('other-status-group');
      if (status === 'å…¶ä»–') {
        otherGroup.style.display = 'block';
      } else {
        otherGroup.style.display = 'none';
      }
    }

    // ICD Code search
    var icdCodes = [
      { code: 'C50', name: 'ä¹³æˆ¿æƒ¡æ€§è…«ç˜¤', related: ['G009', 'G011'] },
      { code: 'G009', name: 'HER2é™½æ€§ä¹³ç™Œ', related: ['C50'] },
      { code: 'G010', name: 'HER2é™½æ€§èƒƒç™Œ', related: [] },
      { code: 'G011', name: 'HER2é™½æ€§è½‰ç§»æ€§ä¹³ç™Œ', related: ['C50'] }
    ];

    function searchICD() {
      var query = document.getElementById('icd-search').value.toUpperCase();
      var suggestions = document.getElementById('icd-suggestions');

      if (query.length < 2) {
        suggestions.classList.remove('show');
        return;
      }

      // Find matching codes
      var matches = icdCodes.filter(function(icd) {
        return icd.code.includes(query) || icd.name.includes(query);
      });

      // Also include related codes
      var matchedCodes = matches.map(function(m) { return m.code; });
      var relatedCodes = [];
      matches.forEach(function(m) {
        m.related.forEach(function(r) {
          if (!matchedCodes.includes(r) && !relatedCodes.includes(r)) {
            relatedCodes.push(r);
          }
        });
      });
      relatedCodes.forEach(function(code) {
        var icd = icdCodes.find(function(i) { return i.code === code; });
        if (icd) matches.push(icd);
      });

      if (matches.length > 0) {
        suggestions.textContent = '';
        matches.forEach(function(icd) {
          var div = document.createElement('div');
          div.className = 'icd-suggestion-item';
          div.textContent = icd.code + ' - ' + icd.name;
          div.onclick = function() { selectICD(icd.code); };
          suggestions.appendChild(div);
        });
        suggestions.classList.add('show');
      } else {
        suggestions.classList.remove('show');
      }
    }

    function selectICD(code) {
      document.getElementById('disease-code').value = code;
      document.getElementById('disease-code-display').textContent = code;
      document.getElementById('icd-search').value = '';
      var suggestions = document.getElementById('icd-suggestions');
      suggestions.classList.remove('show');
      suggestions.textContent = ''; // Clear content so it won't match text queries
    }

    function clearDiseaseCode() {
      document.getElementById('disease-code').value = '';
      document.getElementById('disease-code-display').textContent = '';
      document.getElementById('icd-search').value = '';
    }

    // Drug items management
    function addDrugItem() {
      var drugName = document.getElementById('drug-name').value;
      var weight = document.getElementById('weight').value;
      var dateStart = document.getElementById('use-date-start').value;
      var dateEnd = document.getElementById('use-date-end').value;

      if (!drugName) {
        alert('è«‹é¸æ“‡è—¥å“');
        return;
      }

      var item = {
        name: drugName,
        dose: weight ? (weight * 8) + 'mg' : 'è¨ˆç®—ä¸­',
        quantity: '1',
        dateStart: dateStart,
        dateEnd: dateEnd
      };
      drugItems.push(item);
      renderDrugItems();

      // Clear form
      document.getElementById('drug-name').value = '';
      document.getElementById('use-date-start').value = '';
      document.getElementById('use-date-end').value = '';
    }

    function renderDrugItems() {
      var tbody = document.getElementById('drug-items');
      tbody.textContent = '';
      drugItems.forEach(function(item, index) {
        var tr = document.createElement('tr');

        var tdName = document.createElement('td');
        tdName.textContent = item.name;
        tr.appendChild(tdName);

        var tdDose = document.createElement('td');
        tdDose.textContent = item.dose;
        tr.appendChild(tdDose);

        var tdQty = document.createElement('td');
        tdQty.textContent = item.quantity;
        tr.appendChild(tdQty);

        var tdStart = document.createElement('td');
        tdStart.textContent = item.dateStart;
        tr.appendChild(tdStart);

        var tdEnd = document.createElement('td');
        tdEnd.textContent = item.dateEnd;
        tr.appendChild(tdEnd);

        var tdAction = document.createElement('td');
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-action btn-delete';
        deleteBtn.textContent = 'åˆªé™¤';
        deleteBtn.onclick = function() { removeDrugItem(index); };
        tdAction.appendChild(deleteBtn);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function removeDrugItem(index) {
      drugItems.splice(index, 1);
      renderDrugItems();
    }

    // Date validation
    function validateDateRange() {
      var startDate = document.getElementById('use-date-start').value;
      var endDate = document.getElementById('use-date-end').value;
      var errorEl = document.getElementById('date-error');

      if (startDate && endDate && endDate < startDate) {
        errorEl.classList.add('show');
      } else {
        errorEl.classList.remove('show');
      }
    }

    // ID number validation
    document.getElementById('id-number').addEventListener('blur', function() {
      var value = this.value;
      var errorEl = document.getElementById('id-error');
      var pattern = /^[A-Z][12]\d{8}$/;

      if (value && !pattern.test(value)) {
        errorEl.classList.add('show');
      } else {
        errorEl.classList.remove('show');
      }
    });

    // Gender validation
    document.getElementById('gender').addEventListener('blur', function() {
      var value = this.value.toUpperCase();
      var errorEl = document.getElementById('gender-error');

      if (value && value !== 'M' && value !== 'F') {
        errorEl.classList.add('show');
      } else {
        errorEl.classList.remove('show');
        this.value = value;
      }
    });

    // Common phrase insertion
    function insertCommonPhrase() {
      var phrase = document.getElementById('common-phrases').value;
      if (phrase) {
        document.getElementById('medical-description').value = phrase;
      }
    }

    // File upload handlers
    function handleTestFileUpload() {
      var statusEl = document.getElementById('test-upload-status');
      statusEl.textContent = 'ä¸Šå‚³æˆåŠŸ';
      statusEl.classList.add('show', 'success');
    }

    function handleConsentFileUpload() {
      var statusEl = document.getElementById('consent-upload-status');
      statusEl.textContent = 'ä¸Šå‚³æˆåŠŸ';
      statusEl.classList.add('show', 'success');
    }

    // Form validation
    function validateForm() {
      // Core required fields for submission
      var requiredFields = [
        { id: 'patient-name', name: 'å§“å' },
        { id: 'id-number', name: 'èº«åˆ†è­‰å­—è™Ÿ' },
        { id: 'mrn', name: 'ç—…æ­·è™Ÿ' },
        { id: 'gender', name: 'æ€§åˆ¥' },
        { id: 'birth-date', name: 'å‡ºç”Ÿå¹´æœˆæ—¥' },
        { id: 'apply-type', name: 'ç”³è«‹é¡åˆ¥' }
      ];

      var missing = requiredFields.filter(function(f) {
        return !document.getElementById(f.id).value;
      });
      return missing;
    }

    // Save draft
    function saveDraft() {
      showStatusMessage('å·²å„²å­˜', 'success');
      // Add status indicator
      var statusDiv = document.createElement('div');
      statusDiv.textContent = 'è‰ç¨¿';
      statusDiv.className = 'status-badge status-draft';
      statusDiv.style.marginTop = '10px';
      document.getElementById('status-message').appendChild(statusDiv);
    }

    // Submit for review
    function submitForReview() {
      var missing = validateForm();

      if (missing.length > 0) {
        var names = missing.map(function(f) { return f.name; }).join(', ');
        showStatusMessage('å¿…å¡«æ¬„ä½æœªå¡«å¯«ï¼š' + names, 'error');
        return;
      }

      showStatusMessage('å·²é€å‡º', 'success');
      // Add status indicator
      var statusDiv = document.createElement('div');
      statusDiv.textContent = 'å¾…å¯©æ ¸';
      statusDiv.className = 'status-badge status-pending';
      statusDiv.style.marginTop = '10px';
      document.getElementById('status-message').appendChild(statusDiv);
    }

    function showStatusMessage(message, type) {
      var statusEl = document.getElementById('status-message');
      var contentEl = document.getElementById('status-content');

      contentEl.textContent = message;

      statusEl.className = 'status-message show';
      if (type === 'success') {
        statusEl.classList.add('success');
      } else if (type === 'error') {
        statusEl.classList.add('error');
      }
    }

    // Initialize
    var user = displayUserInfo();
    if (user) {
      // Pre-fill doctor name from logged in user
      // Already set as default value
    }
  </script>
</body>
</html>
