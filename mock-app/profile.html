<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€‹äººè³‡æ–™ - TWPAS</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    .profile-sections {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
    }
    .profile-section {
      background: var(--color-bg-white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .profile-section h3 {
      background: var(--color-bg-light);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-bottom: 1px solid var(--color-border-light);
      font-size: var(--font-size-lg);
      margin: 0;
    }
    .profile-content {
      padding: var(--spacing-xl);
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-xl);
    }
    .info-item label {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xs);
    }
    .info-item .value {
      font-size: var(--font-size-lg);
      font-weight: 500;
      color: var(--color-text);
    }
    .password-change-section {
      margin-top: var(--spacing-lg);
    }
    .password-form {
      display: none;
      margin-top: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: var(--color-bg-light);
      border-radius: var(--radius-md);
    }
    .password-form.show {
      display: block;
    }
    .password-form .form-group {
      max-width: 400px;
    }
    .form-actions {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }
    .template-table {
      width: 100%;
    }
    .template-table th,
    .template-table td {
      padding: var(--spacing-md);
      text-align: left;
      border-bottom: 1px solid var(--color-border-light);
    }
    .template-table th {
      background: var(--color-bg-light);
      font-weight: 500;
    }
    .tab-buttons {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }
    .tab-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      border: 1px solid var(--color-border-input);
      background: var(--color-bg-white);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    .template-form {
      display: none;
      padding: var(--spacing-lg);
      background: var(--color-bg-light);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-lg);
    }
    .template-form.show {
      display: block;
    }
    .message {
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-lg);
      display: none;
    }
    .message.show {
      display: block;
    }
    .message.success {
      background: var(--color-approved-bg);
      color: var(--color-approved-text);
    }
    .message.error {
      background: var(--color-rejected-bg);
      color: var(--color-rejected-text);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>TWPAS</h1>
    <div class="header-right">
      <span class="user-badge" id="user-role-badge"></span>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><span class="icon">ğŸ“Š</span> å„€è¡¨æ¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">æ¡ˆä»¶ç®¡ç†</div>
      <li><a href="/claim-form"><span class="icon">â•</span> æ–°å¢ç”³è«‹æ¡ˆ</a></li>
      <li><a href="/claim"><span class="icon">ğŸ“‹</span> ç”³è«‹æ¡ˆä»¶ç®¡ç†</a></li>
      <li><a href="/claim?status=draft"><span class="icon">ğŸ“</span> æˆ‘çš„è‰ç¨¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">è³‡æ–™ç®¡ç†</div>
      <li><a href="/patient"><span class="icon">ğŸ‘¤</span> ç—…äººè³‡æ–™ç®¡ç†</a></li>
      <li><a href="/valueset"><span class="icon">ğŸ“š</span> å€¼é›†ç®¡ç†</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">ç³»çµ±åŠŸèƒ½</div>
      <li><a href="/fhir"><span class="icon">ğŸ”„</span> FHIR è½‰æ›</a></li>
      <li><a href="/nhi-upload"><span class="icon">â˜ï¸</span> å¥ä¿ä¸Šå‚³</a></li>
      <div class="menu-divider"></div>
      <li><a href="/profile" class="active"><span class="icon">ğŸ‘¤</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="/settings"><span class="icon">âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
    </ul>
  </nav>

  <main class="main">
    <div class="page-header">
      <h2>æˆ‘çš„å¸³æˆ¶</h2>
    </div>

    <div id="message-container" class="message"></div>

    <div class="profile-sections">
      <!-- åŸºæœ¬è³‡æ–™ -->
      <section class="profile-section">
        <h3>åŸºæœ¬è³‡æ–™</h3>
        <div class="profile-content">
          <div class="info-grid">
            <div class="info-item">
              <label>å¸³è™Ÿ</label>
              <div class="value" id="profile-username">-</div>
            </div>
            <div class="info-item">
              <label>ç§‘åˆ¥</label>
              <div class="value" id="profile-department">-</div>
            </div>
            <div class="info-item">
              <label>å§“å</label>
              <div class="value" id="profile-name">-</div>
            </div>
            <div class="info-item">
              <label>éš¸å±¬é†«å¸«</label>
              <div class="value" id="profile-supervisor">-</div>
            </div>
            <div class="info-item">
              <label>ç”Ÿæ—¥</label>
              <div class="value" id="profile-birthday">-</div>
            </div>
            <div class="info-item">
              <label>é†«å¸«ä»£ç¢¼</label>
              <div class="value" id="profile-doctor-code">-</div>
            </div>
            <div class="info-item">
              <label>èº«åˆ†è­‰å­—è™Ÿ</label>
              <div class="value" id="profile-id-number">-</div>
            </div>
            <div class="info-item">
              <label>è·ç¨±</label>
              <div class="value" id="profile-title">-</div>
            </div>
            <div class="info-item">
              <label>è¯çµ¡é›»è©±</label>
              <div class="value" id="profile-phone">-</div>
            </div>
            <div class="info-item">
              <label>ä¿¡ç®±</label>
              <div class="value" id="profile-email">-</div>
            </div>
          </div>
        </div>
      </section>

      <!-- è®Šæ›´å¯†ç¢¼ -->
      <section class="profile-section">
        <h3>æ˜¯å¦éœ€æ›´æ–°å¯†ç¢¼</h3>
        <div class="profile-content">
          <p>å®šæœŸæ›´æ›å¯†ç¢¼å¯ä»¥æå‡å®‰å…¨æ€§ã€‚</p>
          <div class="password-change-section">
            <button type="button" class="btn-primary" id="change-password-btn" onclick="showPasswordForm()" aria-label="è®Šæ›´å¯†ç¢¼">ç«‹å³ä¿®æ”¹</button>
            <div id="password-form" class="password-form">
              <div class="form-group">
                <label for="current-password">ç›®å‰å¯†ç¢¼</label>
                <input type="password" id="current-password" name="current-password">
              </div>
              <div class="form-group">
                <label for="new-password">æ–°å¯†ç¢¼</label>
                <input type="password" id="new-password" name="new-password">
              </div>
              <div class="form-group">
                <label for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
                <input type="password" id="confirm-password" name="confirm-password">
              </div>
              <div class="form-actions">
                <button type="button" class="btn-primary" onclick="submitPasswordChange()">ç¢ºèª</button>
                <button type="button" class="btn-secondary" onclick="hidePasswordForm()">å–æ¶ˆ</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ç—…æ­·æ‘˜è¦ç¯„æœ¬ -->
      <section class="profile-section">
        <h3>ç”³è«‹æ¡ˆæ‘˜è¦ç¯„æœ¬</h3>
        <div class="profile-content">
          <p class="section-description" id="template-desc">ç”³è«‹æ¡ˆå¸¸ç”¨ç—…æ­·æ‘˜è¦ç¯„æœ¬</p>
          <div class="tab-buttons">
            <button class="tab-btn active">æ²»ç™‚éç¨‹</button>
          </div>
          <table class="template-table">
            <thead>
              <tr>
                <th>ç¯„æœ¬åç¨±</th>
                <th>ç¯„æœ¬å…§æ–‡</th>
                <th>å»ºç«‹æ—¥æœŸ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="template-list">
              <!-- Template rows will be inserted here -->
            </tbody>
          </table>
          <button type="button" class="btn-primary mt-1" onclick="showTemplateForm()">åŠ å…¥æ–‡æœ¬</button>
          <div id="template-form" class="template-form">
            <div class="form-group">
              <label for="template-name">åç¨±</label>
              <input type="text" id="template-name" name="template-name" aria-label="ç¯„æœ¬åç¨±">
            </div>
            <div class="form-group">
              <label for="template-content">å…§æ–‡</label>
              <textarea id="template-content" name="template-content" rows="4" aria-label="ç¯„æœ¬å…§æ–‡"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn-primary" onclick="saveTemplate()">å„²å­˜</button>
              <button type="button" class="btn-secondary" onclick="hideTemplateForm()">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="/shared.js"></script>
  <script>
    // Mock user data with more details
    const userProfiles = {
      'TWPASTWPAS': {
        name: 'æ´ªä¸»ä»»',
        department: 'ä¹³ç™Œ',
        supervisor: 'ç„¡',
        birthday: '1975-05-15',
        doctorCode: 'D001234',
        idNumber: 'A123***789',
        title: 'ä¸»ä»»é†«å¸«',
        phone: '02-12345678',
        email: 'hong@hospital.tw'
      },
      'doctor01': {
        name: 'å¼µé†«å¸«',
        department: 'è…«ç˜¤ç§‘',
        supervisor: 'æ´ªä¸»ä»»',
        birthday: '1980-03-20',
        doctorCode: 'D005678',
        idNumber: 'B234***890',
        title: 'ä¸»æ²»é†«å¸«',
        phone: '02-23456789',
        email: 'zhang@hospital.tw'
      }
    };

    // Templates storage
    let templates = JSON.parse(localStorage.getItem('templates') || '[]');

    // Initialize page
    function initProfile() {
      const user = checkAuth();
      if (!user) return;

      // Display user info in header
      const roleEl = document.getElementById('user-role-badge');
      if (roleEl) roleEl.textContent = user.role;

      // Display profile data
      const profile = userProfiles[user.username] || {
        name: user.name || user.username,
        department: user.department || '-',
        supervisor: '-',
        birthday: '-',
        doctorCode: '-',
        idNumber: '-',
        title: user.role,
        phone: '-',
        email: '-'
      };

      document.getElementById('profile-username').textContent = user.username;
      document.getElementById('profile-department').textContent = profile.department;
      document.getElementById('profile-name').textContent = profile.name;
      document.getElementById('profile-supervisor').textContent = profile.supervisor;
      document.getElementById('profile-birthday').textContent = profile.birthday;
      document.getElementById('profile-doctor-code').textContent = profile.doctorCode;
      document.getElementById('profile-id-number').textContent = profile.idNumber;
      document.getElementById('profile-title').textContent = profile.title;
      document.getElementById('profile-phone').textContent = profile.phone;
      document.getElementById('profile-email').textContent = profile.email;

      // Render templates
      renderTemplates();
    }

    function showPasswordForm() {
      document.getElementById('password-form').classList.add('show');
    }

    function hidePasswordForm() {
      document.getElementById('password-form').classList.remove('show');
      // Clear form
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
    }

    function submitPasswordChange() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const user = JSON.parse(sessionStorage.getItem('user'));

      // Validate current password
      const validPasswords = {
        'TWPASTWPAS': 'TWPASTWPAS',
        'doctor01': 'Pass1234!'
      };

      if (validPasswords[user.username] && validPasswords[user.username] !== currentPassword) {
        showMessage('ç›®å‰å¯†ç¢¼ä¸æ­£ç¢º', 'error');
        return;
      }

      // Validate password match
      if (newPassword !== confirmPassword) {
        showMessage('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', 'error');
        return;
      }

      // Validate password strength (at least 8 chars)
      if (newPassword.length < 8) {
        showMessage('å¯†ç¢¼é•·åº¦ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒ', 'error');
        return;
      }

      // Success
      showMessage('å¯†ç¢¼å·²æ›´æ–°', 'success');
      hidePasswordForm();
    }

    function showTemplateForm() {
      document.getElementById('template-form').classList.add('show');
    }

    function hideTemplateForm() {
      document.getElementById('template-form').classList.remove('show');
      document.getElementById('template-name').value = '';
      document.getElementById('template-content').value = '';
    }

    function saveTemplate() {
      const name = document.getElementById('template-name').value.trim();
      const content = document.getElementById('template-content').value.trim();

      if (!name) {
        showMessage('ç¯„æœ¬åç¨±ç‚ºå¿…å¡«', 'error');
        return;
      }

      templates.push({
        name,
        content,
        createdAt: new Date().toISOString().split('T')[0]
      });

      localStorage.setItem('templates', JSON.stringify(templates));
      renderTemplates();
      hideTemplateForm();
      showMessage('ç¯„æœ¬å·²æ–°å¢', 'success');
      // Remove description to avoid conflict with newly added template name
      const descEl = document.getElementById('template-desc');
      if (descEl) descEl.remove();
    }

    function renderTemplates() {
      const tbody = document.getElementById('template-list');
      // Clear existing rows
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }

      if (templates.length === 0) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = 4;
        emptyCell.className = 'empty-state';
        emptyCell.textContent = 'å°šç„¡ç¯„æœ¬';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
      }

      templates.forEach(function(t, i) {
        const row = document.createElement('tr');

        const nameCell = document.createElement('td');
        nameCell.textContent = t.name;
        row.appendChild(nameCell);

        const contentCell = document.createElement('td');
        contentCell.textContent = t.content.length > 50 ? t.content.substring(0, 50) + '...' : t.content;
        row.appendChild(contentCell);

        const dateCell = document.createElement('td');
        dateCell.textContent = t.createdAt;
        row.appendChild(dateCell);

        const actionCell = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-action btn-edit';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.onclick = function() { editTemplate(i); };
        actionCell.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-action btn-delete';
        deleteBtn.textContent = 'åˆªé™¤';
        deleteBtn.onclick = function() { deleteTemplate(i); };
        actionCell.appendChild(deleteBtn);

        row.appendChild(actionCell);
        tbody.appendChild(row);
      });
    }

    function editTemplate(index) {
      const template = templates[index];
      document.getElementById('template-name').value = template.name;
      document.getElementById('template-content').value = template.content;
      showTemplateForm();
      // Store editing index
      document.getElementById('template-form').dataset.editIndex = index;
    }

    function deleteTemplate(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¯„æœ¬å—?')) {
        templates.splice(index, 1);
        localStorage.setItem('templates', JSON.stringify(templates));
        renderTemplates();
        showMessage('ç¯„æœ¬å·²åˆªé™¤', 'success');
      }
    }

    function showMessage(text, type) {
      const container = document.getElementById('message-container');
      container.textContent = text;
      container.className = 'message show ' + type;
      setTimeout(function() {
        container.classList.remove('show');
      }, 3000);
    }

    // Initialize on page load
    initProfile();
  </script>
</body>
</html>
