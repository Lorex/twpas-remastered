<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”³è«‹è¡¨æ­·å²è¨˜éŒ„ - TWPAS</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    /* Page-specific styles */
    .breadcrumb {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-lg);
    }
    .breadcrumb a {
      color: var(--color-primary);
      text-decoration: none;
    }

    .btn-row {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-xl);
    }
    .btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
      border: none;
      text-decoration: none;
      display: inline-block;
    }

    .patient-info-card {
      background: var(--color-bg-white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .patient-info-card h3 {
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-lg);
      color: var(--color-text);
    }
    .patient-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-lg);
    }
    .patient-info-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    .patient-info-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }
    .patient-info-value {
      font-size: var(--font-size-lg);
      font-weight: 500;
    }

    .timeline {
      border-left: 2px solid var(--color-border);
      margin-left: var(--spacing-lg);
      padding-left: var(--spacing-xl);
    }
    .timeline-item {
      position: relative;
      padding-bottom: var(--spacing-xl);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.75rem;
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-primary);
    }
    .timeline-date {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    .timeline-content {
      font-size: var(--font-size-base);
      color: var(--color-text);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>TWPAS</h1>
    <div class="header-right">
      <span class="user-badge" id="user-role-badge"></span>
      <span id="username-display"></span>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><span class="icon">ğŸ“Š</span> å„€è¡¨æ¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">æ¡ˆä»¶ç®¡ç†</div>
      <li><a href="/claim-form"><span class="icon">â•</span> æ–°å¢ç”³è«‹æ¡ˆ</a></li>
      <li><a href="/claim"><span class="icon">ğŸ“‹</span> ç”³è«‹æ¡ˆä»¶ç®¡ç†</a></li>
      <li><a href="/claim?status=draft"><span class="icon">ğŸ“</span> æˆ‘çš„è‰ç¨¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">è³‡æ–™ç®¡ç†</div>
      <li><a href="/patient"><span class="icon">ğŸ‘¤</span> ç—…äººè³‡æ–™ç®¡ç†</a></li>
      <li><a href="/valueset"><span class="icon">ğŸ“š</span> å€¼é›†ç®¡ç†</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">ç³»çµ±åŠŸèƒ½</div>
      <li><a href="/fhir"><span class="icon">ğŸ”„</span> FHIR è½‰æ›</a></li>
      <li><a href="/nhi-upload"><span class="icon">â˜ï¸</span> å¥ä¿ä¸Šå‚³</a></li>
      <div class="menu-divider"></div>
      <li><a href="/profile"><span class="icon">ğŸ‘¤</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="/settings"><span class="icon">âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
    </ul>
  </nav>

  <main class="main">
    <div class="breadcrumb">
      <a href="/dashboard">é¦–é </a> / <a href="/patient">ç—…äººè³‡æ–™ç®¡ç†</a> / ç”³è«‹è¡¨æ­·å²è¨˜éŒ„
    </div>

    <div class="page-header">
      <h2>ç”³è«‹è¡¨æ­·å²è¨˜éŒ„</h2>
    </div>

    <!-- Patient Info Card -->
    <div class="patient-info-card">
      <h3>ç—…äººåŸºæœ¬è³‡è¨Š</h3>
      <div class="patient-info-grid">
        <div class="patient-info-item">
          <div class="patient-info-label">ç—…æ­·è™Ÿ</div>
          <div class="patient-info-value" id="patient-mrn">-</div>
        </div>
        <div class="patient-info-item">
          <div class="patient-info-label">å§“å</div>
          <div class="patient-info-value" id="patient-name">-</div>
        </div>
        <div class="patient-info-item">
          <div class="patient-info-label">èº«åˆ†è­‰å­—è™Ÿ</div>
          <div class="patient-info-value" id="patient-id">-</div>
        </div>
      </div>
    </div>

    <!-- Claims History Table -->
    <div class="card">
      <div class="card-header">
        <span>ç”³è«‹æ¡ˆä»¶æ­·å²</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>ç”³è«‹é¡åˆ¥</th>
            <th>ç”³è«‹æ¬¡æ•¸</th>
            <th>ç–¾ç—…åˆ¥</th>
            <th>ç”³è«‹è—¥å“</th>
            <th>ç”³è«‹æ—¥æœŸ</th>
            <th>ç‹€æ…‹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="history-list"></tbody>
      </table>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
      <a href="/claim-form" class="btn btn-primary">æ–°å¢ç”³è«‹æ¡ˆ</a>
    </div>
  </main>

  <script src="/shared.js"></script>
  <script>
    // Mock history data for different patients
    const patientHistories = {
      'E125123456': [
        { applyType: 'é€æ ¸', count: 1, disease: 'G009', drug: 'Herceptin SC', applyDate: '2026-01-15', status: 'è‰ç¨¿' },
        { applyType: 'é€æ ¸', count: 2, disease: 'G009', drug: 'Kadcyla', applyDate: '2026-01-20', status: 'å¾…å¯©æ ¸' },
      ],
      'A123456789': [
        { applyType: 'é€æ ¸', count: 1, disease: 'C001', drug: 'Keytruda', applyDate: '2025-12-01', status: 'å·²æ ¸å‡†' },
        { applyType: 'çºŒç”¨', count: 1, disease: 'C001', drug: 'Keytruda', applyDate: '2026-01-15', status: 'å¾…å¯©æ ¸' },
      ],
      'B234567890': [
        { applyType: 'é€æ ¸', count: 1, disease: 'B002', drug: 'Opdivo', applyDate: '2025-11-15', status: 'å·²æ ¸å‡†' },
      ],
      'C345678901': [
        { applyType: 'é€æ ¸', count: 1, disease: 'A003', drug: 'Tecentriq', applyDate: '2026-01-05', status: 'å¯©æ ¸ä¸­' },
      ],
      'D456789012': [],
    };

    function goBack() {
      window.location.href = '/patient';
    }

    function loadPatientInfo() {
      const params = getUrlParams();
      const patientId = params.get('patient');
      const mrn = params.get('mrn');
      const name = params.get('name');

      if (mrn) {
        document.getElementById('patient-mrn').textContent = mrn;
      }
      if (name) {
        document.getElementById('patient-name').textContent = decodeURIComponent(name);
      }
      if (patientId) {
        document.getElementById('patient-id').textContent = patientId;
      }

      return patientId;
    }

    function renderHistory(patientId) {
      const tbody = document.getElementById('history-list');
      tbody.textContent = '';

      const history = patientHistories[patientId] || [];

      if (history.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.textContent = 'ç„¡ç”³è«‹æ¡ˆä»¶è¨˜éŒ„';
        td.style.textAlign = 'center';
        td.style.padding = '2rem';
        td.style.color = 'var(--color-text-secondary)';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      history.forEach(h => {
        const tr = document.createElement('tr');

        // Apply type
        const typeTd = document.createElement('td');
        typeTd.textContent = h.applyType;
        tr.appendChild(typeTd);

        // Count
        const countTd = document.createElement('td');
        countTd.textContent = h.count;
        tr.appendChild(countTd);

        // Disease
        const diseaseTd = document.createElement('td');
        diseaseTd.textContent = h.disease;
        tr.appendChild(diseaseTd);

        // Drug
        const drugTd = document.createElement('td');
        drugTd.textContent = h.drug;
        tr.appendChild(drugTd);

        // Apply date
        const dateTd = document.createElement('td');
        dateTd.textContent = h.applyDate;
        tr.appendChild(dateTd);

        // Status
        const statusTd = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.className = 'status-badge';
        switch (h.status) {
          case 'è‰ç¨¿':
            statusBadge.classList.add('status-draft');
            break;
          case 'å¾…å¯©æ ¸':
            statusBadge.classList.add('status-pending');
            break;
          case 'å¯©æ ¸ä¸­':
            statusBadge.classList.add('status-reviewing');
            break;
          case 'å·²æ ¸å‡†':
            statusBadge.classList.add('status-approved');
            break;
          case 'å·²é§å›':
            statusBadge.classList.add('status-rejected');
            break;
        }
        statusBadge.textContent = h.status;
        statusTd.appendChild(statusBadge);
        tr.appendChild(statusTd);

        // Actions
        const actionTd = document.createElement('td');
        if (h.status === 'è‰ç¨¿') {
          const editBtn = document.createElement('a');
          editBtn.href = '/claim-form?edit=true';
          editBtn.className = 'btn-action btn-edit';
          editBtn.textContent = 'ç·¨è¼¯';
          actionTd.appendChild(editBtn);
        }
        const viewBtn = document.createElement('a');
        viewBtn.href = '#';
        viewBtn.className = 'btn-action btn-view';
        viewBtn.textContent = 'æª¢è¦–';
        viewBtn.onclick = (e) => { e.preventDefault(); alert('æª¢è¦–åŠŸèƒ½é–‹ç™¼ä¸­'); };
        actionTd.appendChild(viewBtn);
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      const user = displayUserInfo();
      if (user) {
        const patientId = loadPatientInfo();
        renderHistory(patientId);
      }
    });
  </script>
</body>
</html>
