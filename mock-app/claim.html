<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”³è«‹æ¡ˆä»¶ç®¡ç† - TWPAS</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    /* Tabs styling */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: var(--spacing-lg);
      background: var(--color-bg-white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      overflow-x: auto;
    }
    .tabs [role="tab"] {
      padding: var(--spacing-md) var(--spacing-lg);
      border: none;
      background: none;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-size: var(--font-size-base);
      white-space: nowrap;
      position: relative;
      transition: color 0.2s;
    }
    .tabs [role="tab"]:hover {
      color: var(--color-primary);
      background: var(--color-bg-hover);
    }
    .tabs [role="tab"][aria-selected="true"] {
      color: var(--color-primary);
      font-weight: 500;
    }
    .tabs [role="tab"][aria-selected="true"]::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--color-primary);
    }
    /* Filter section */
    .advanced-filter {
      background: var(--color-bg-white);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .filter-title {
      font-weight: 500;
      margin-bottom: var(--spacing-md);
      color: var(--color-text);
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      align-items: flex-end;
    }
    .filter-group-checkbox {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }
    .filter-group-checkbox label {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      cursor: pointer;
    }
    .filter-group-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .quick-search {
      margin-left: auto;
    }
    .quick-search input {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--color-border-input);
      border-radius: var(--radius-sm);
      width: 200px;
    }
    .filter-buttons {
      display: flex;
      gap: var(--spacing-sm);
    }
    /* Empty state */
    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--color-text-secondary);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>TWPAS ç™Œç—‡ç”¨è—¥äº‹å‰å¯©æŸ¥ç³»çµ±</h1>
    <div class="header-right">
      <span class="user-badge" id="user-role-badge"></span>
      <span id="username-display"></span>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>

  <nav class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><span class="icon">ğŸ“Š</span> å„€è¡¨æ¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">æ¡ˆä»¶ç®¡ç†</div>
      <li><a href="/claim-form"><span class="icon">â•</span> æ–°å¢ç”³è«‹æ¡ˆ</a></li>
      <li><a href="/claim" id="nav-claim-list"><span class="icon">ğŸ“‹</span> ç”³è«‹æ¡ˆä»¶ç®¡ç†</a></li>
      <li><a href="/claim?status=draft" id="nav-my-drafts"><span class="icon">ğŸ“</span> æˆ‘çš„è‰ç¨¿</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">è³‡æ–™ç®¡ç†</div>
      <li><a href="/patient"><span class="icon">ğŸ‘¤</span> ç—…äººè³‡æ–™ç®¡ç†</a></li>
      <li><a href="/valueset"><span class="icon">ğŸ“š</span> å€¼é›†ç®¡ç†</a></li>
      <div class="menu-divider"></div>
      <div class="menu-label">ç³»çµ±åŠŸèƒ½</div>
      <li><a href="/fhir"><span class="icon">ğŸ”„</span> FHIR è½‰æ›</a></li>
      <li><a href="/nhi-upload"><span class="icon">â˜ï¸</span> å¥ä¿ä¸Šå‚³</a></li>
      <div class="menu-divider"></div>
      <li><a href="/profile"><span class="icon">ğŸ‘¤</span> å€‹äººè³‡æ–™</a></li>
      <li><a href="/settings"><span class="icon">âš™ï¸</span> ç³»çµ±è¨­å®š</a></li>
    </ul>
  </nav>

  <main class="main">
    <div class="page-header">
      <h2 id="page-title">ç”³è«‹æ¡ˆä»¶ç®¡ç†</h2>
      <a href="/claim-form" class="btn-primary">æ–°å¢ç”³è«‹æ¡ˆ</a>
    </div>

    <!-- Advanced Filter Section -->
    <div class="advanced-filter">
      <div class="filter-title">é€²éšç¯©é¸</div>
      <div class="filter-row">
        <div class="filter-group-checkbox">
          <label>
            <input type="checkbox" id="filter-songhe" value="é€æ ¸">
            <span>é€æ ¸</span>
          </label>
          <label>
            <input type="checkbox" id="filter-bujian" value="è£œä»¶">
            <span>è£œä»¶</span>
          </label>
          <label>
            <input type="checkbox" id="filter-shenfu" value="ç”³å¾©">
            <span>ç”³å¾©</span>
          </label>
          <label>
            <input type="checkbox" id="filter-zhengyi" value="çˆ­è­°å¯©è­°">
            <span>çˆ­è­°å¯©è­°</span>
          </label>
          <label>
            <input type="checkbox" id="filter-yidong" value="è³‡æ–™ç•°å‹•">
            <span>è³‡æ–™ç•°å‹•</span>
          </label>
        </div>
        <div class="filter-group">
          <label for="filter-mrn">ç—…æ­·è™Ÿ</label>
          <input type="text" id="filter-mrn" placeholder="è¼¸å…¥ç—…æ­·è™Ÿ">
        </div>
        <div class="filter-group">
          <label for="filter-idnumber">èº«ä»½è­‰å­—è™Ÿ</label>
          <input type="text" id="filter-idnumber" placeholder="è¼¸å…¥èº«ä»½è­‰å­—è™Ÿ">
        </div>
        <div class="filter-group">
          <label for="filter-name">å§“å</label>
          <input type="text" id="filter-name" placeholder="è¼¸å…¥å§“å">
        </div>
        <div class="filter-group">
          <label for="filter-disease">ç–¾ç—…åˆ¥</label>
          <select id="filter-disease">
            <option value="">è«‹é¸æ“‡</option>
            <option value="G009">G009</option>
            <option value="G010">G010</option>
            <option value="G011">G011</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-drug">ç”³è«‹è—¥å“</label>
          <select id="filter-drug">
            <option value="">è«‹é¸æ“‡</option>
            <option value="Herceptin SC">Herceptin SC</option>
            <option value="Kadcyla">Kadcyla</option>
            <option value="Perjeta">Perjeta</option>
            <option value="Phesgo">Phesgo</option>
            <option value="Trastuzumab">Trastuzumab</option>
          </select>
        </div>
      </div>
      <div class="filter-row" style="margin-top: var(--spacing-md);">
        <div class="filter-group">
          <label for="filter-image-date-start">å½±åƒå­¸æª¢æŸ¥æ—¥æœŸèµ·</label>
          <input type="date" id="filter-image-date-start">
        </div>
        <div class="filter-group">
          <label for="filter-image-date-end">å½±åƒå­¸æª¢æŸ¥æ—¥æœŸè¿„</label>
          <input type="date" id="filter-image-date-end">
        </div>
        <div class="filter-group">
          <label for="filter-apply-date-start">ç”³è«‹æ—¥æœŸèµ·</label>
          <input type="date" id="filter-apply-date-start">
        </div>
        <div class="filter-group">
          <label for="filter-apply-date-end">ç”³è«‹æ—¥æœŸè¿„</label>
          <input type="date" id="filter-apply-date-end">
        </div>
        <div class="filter-buttons">
          <button class="btn-primary" onclick="applyFilters()">æŸ¥è©¢</button>
          <button class="btn-secondary" onclick="clearFilters()">æ¸…é™¤</button>
        </div>
        <div class="quick-search">
          <input type="text" id="quick-search" placeholder="å¿«é€Ÿæœå°‹..." oninput="quickSearch()">
        </div>
      </div>
    </div>

    <!-- Status Tabs -->
    <div class="tabs" role="tablist">
      <button role="tab" aria-selected="true" data-status="è‰ç¨¿" onclick="selectTab(this)">è‰ç¨¿</button>
      <button role="tab" aria-selected="false" data-status="å¾…å¯©æ ¸" onclick="selectTab(this)">å¾…å¯©æ ¸</button>
      <button role="tab" aria-selected="false" data-status="é€å¯©ä¸­" onclick="selectTab(this)">é€å¯©ä¸­</button>
      <button role="tab" aria-selected="false" data-status="é€šé" onclick="selectTab(this)">é€šé</button>
      <button role="tab" aria-selected="false" data-status="æœªé€šé" onclick="selectTab(this)">æœªé€šé</button>
      <button role="tab" aria-selected="false" data-status="çˆ­å¯©" onclick="selectTab(this)">çˆ­å¯©</button>
      <button role="tab" aria-selected="false" data-status="çºŒä»¶æé†’" onclick="selectTab(this)">çºŒä»¶æé†’</button>
      <button role="tab" aria-selected="false" data-status="çµæ¡ˆ" onclick="selectTab(this)">çµæ¡ˆ</button>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>ç”³è«‹é¡åˆ¥</th>
            <th>ç”³è«‹æ¬¡æ•¸</th>
            <th>ç—…æ­·è™Ÿ</th>
            <th>å§“å</th>
            <th>èº«ä»½è­‰å­—è™Ÿ</th>
            <th>ç–¾ç—…åˆ¥</th>
            <th>ç”³è«‹è—¥å“</th>
            <th>ç”³è«‹æ—¥æœŸ</th>
            <th>å½±åƒå­¸æª¢æŸ¥</th>
            <th>å»ºç«‹æ—¥æœŸ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="claim-list"></tbody>
      </table>
      <div id="no-data" class="no-data" style="display: none;">ç„¡è³‡æ–™</div>
      <div class="pagination" id="pagination">
        <button>Â«</button>
        <button class="active">1</button>
        <button>2</button>
        <button>Â»</button>
      </div>
    </div>
  </main>

  <script src="/shared.js"></script>
  <script>
    // Mock data
    const claims = [
      { applyType: 'é€æ ¸', count: 1, mrn: '1234567', name: 'æ¸¬è©¦ç—…äºº', idNumber: 'E125123456', disease: 'G009', drug: 'Herceptin SC', applyDate: '2025-09-23', imageDate: '2026-02-02', createDate: '2025-09-20', status: 'è‰ç¨¿' },
      { applyType: 'é€æ ¸', count: 2, mrn: '1234567', name: 'æ¸¬è©¦ç—…äºº', idNumber: 'E125123456', disease: 'G009', drug: 'Kadcyla', applyDate: '2025-10-15', imageDate: '2025-10-10', createDate: '2025-10-12', status: 'å¾…å¯©æ ¸' },
      { applyType: 'è£œä»¶', count: 1, mrn: '2345678', name: 'ç‹å°æ˜', idNumber: 'A123456789', disease: 'G010', drug: 'Perjeta', applyDate: '2025-11-01', imageDate: '2025-10-28', createDate: '2025-10-28', status: 'é€å¯©ä¸­' },
      { applyType: 'ç”³å¾©', count: 1, mrn: '3456789', name: 'æå°è¯', idNumber: 'B234567890', disease: 'G009', drug: 'Trastuzumab', applyDate: '2025-08-15', imageDate: '2025-08-10', createDate: '2025-08-10', status: 'é€šé' },
      { applyType: 'é€æ ¸', count: 3, mrn: '4567890', name: 'å¼µå¤§åŒ', idNumber: 'C345678901', disease: 'G011', drug: 'Phesgo', applyDate: '2025-07-20', imageDate: '2025-07-18', createDate: '2025-07-15', status: 'æœªé€šé' },
      { applyType: 'é€æ ¸', count: 1, mrn: '5678901', name: 'é™³ç¾éº—', idNumber: 'D456789012', disease: 'G009', drug: 'Herceptin SC', applyDate: '2025-06-01', imageDate: '2025-05-28', createDate: '2025-05-25', status: 'çˆ­å¯©' },
      { applyType: 'é€æ ¸', count: 2, mrn: '6789012', name: 'æ—å¿—å¼·', idNumber: 'E567890123', disease: 'G010', drug: 'Kadcyla', applyDate: '2025-04-01', imageDate: '2025-03-28', createDate: '2025-03-25', status: 'çºŒä»¶æé†’' },
      { applyType: 'é€æ ¸', count: 1, mrn: '7890123', name: 'é»ƒå°ç‡•', idNumber: 'F678901234', disease: 'G011', drug: 'Perjeta', applyDate: '2025-02-01', imageDate: '2025-01-28', createDate: '2025-01-25', status: 'çµæ¡ˆ' },
    ];

    let currentStatus = 'è‰ç¨¿';
    let filteredClaims = [];

    function selectTab(tab) {
      // Update tab states
      document.querySelectorAll('[role="tab"]').forEach(t => t.setAttribute('aria-selected', 'false'));
      tab.setAttribute('aria-selected', 'true');
      currentStatus = tab.dataset.status;
      applyFilters();
    }

    function renderClaims(data) {
      const tbody = document.getElementById('claim-list');
      const noData = document.getElementById('no-data');
      tbody.textContent = '';

      if (data.length === 0) {
        noData.style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      noData.style.display = 'none';
      document.getElementById('pagination').style.display = 'flex';

      data.forEach(c => {
        const tr = document.createElement('tr');
        tr.onclick = () => window.location.href = '/claim-detail';

        const cells = [c.applyType, c.count, c.mrn, c.name, c.idNumber, c.disease, c.drug, c.applyDate, c.imageDate, c.createDate];
        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });

        // Actions cell
        const actionTd = document.createElement('td');

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-action btn-edit';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.onclick = e => { e.stopPropagation(); window.location.href = '/claim-form?edit=1'; };
        // Disable edit for non-draft
        if (c.status !== 'è‰ç¨¿') {
          editBtn.disabled = true;
          editBtn.style.opacity = '0.5';
          editBtn.style.cursor = 'not-allowed';
        }
        actionTd.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-action btn-delete';
        deleteBtn.textContent = 'åˆªé™¤';
        deleteBtn.onclick = e => { e.stopPropagation(); confirmDelete(); };
        // Disable delete for non-draft
        if (c.status !== 'è‰ç¨¿') {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
        actionTd.appendChild(deleteBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      // Filter by status tab
      let result = claims.filter(c => c.status === currentStatus);

      // Filter by apply type checkboxes
      const checkedTypes = [];
      if (document.getElementById('filter-songhe').checked) checkedTypes.push('é€æ ¸');
      if (document.getElementById('filter-bujian').checked) checkedTypes.push('è£œä»¶');
      if (document.getElementById('filter-shenfu').checked) checkedTypes.push('ç”³å¾©');
      if (document.getElementById('filter-zhengyi').checked) checkedTypes.push('çˆ­è­°å¯©è­°');
      if (document.getElementById('filter-yidong').checked) checkedTypes.push('è³‡æ–™ç•°å‹•');

      if (checkedTypes.length > 0) {
        result = result.filter(c => checkedTypes.includes(c.applyType));
      }

      // Filter by MRN
      const mrn = document.getElementById('filter-mrn').value.trim();
      if (mrn) {
        result = result.filter(c => c.mrn.includes(mrn));
      }

      // Filter by ID Number
      const idNumber = document.getElementById('filter-idnumber').value.trim();
      if (idNumber) {
        result = result.filter(c => c.idNumber.includes(idNumber));
      }

      // Filter by Name
      const name = document.getElementById('filter-name').value.trim();
      if (name) {
        result = result.filter(c => c.name.includes(name));
      }

      // Filter by Disease
      const disease = document.getElementById('filter-disease').value;
      if (disease) {
        result = result.filter(c => c.disease === disease);
      }

      // Filter by Drug
      const drug = document.getElementById('filter-drug').value;
      if (drug) {
        result = result.filter(c => c.drug === drug);
      }

      filteredClaims = result;
      renderClaims(result);
    }

    function clearFilters() {
      document.getElementById('filter-songhe').checked = false;
      document.getElementById('filter-bujian').checked = false;
      document.getElementById('filter-shenfu').checked = false;
      document.getElementById('filter-zhengyi').checked = false;
      document.getElementById('filter-yidong').checked = false;
      document.getElementById('filter-mrn').value = '';
      document.getElementById('filter-idnumber').value = '';
      document.getElementById('filter-name').value = '';
      document.getElementById('filter-disease').value = '';
      document.getElementById('filter-drug').value = '';
      document.getElementById('filter-image-date-start').value = '';
      document.getElementById('filter-image-date-end').value = '';
      document.getElementById('filter-apply-date-start').value = '';
      document.getElementById('filter-apply-date-end').value = '';
      document.getElementById('quick-search').value = '';
      applyFilters();
    }

    function quickSearch() {
      const query = document.getElementById('quick-search').value.toLowerCase().trim();
      if (!query) {
        applyFilters();
        return;
      }

      let result = claims.filter(c => c.status === currentStatus);
      result = result.filter(c =>
        c.name.toLowerCase().includes(query) ||
        c.mrn.includes(query) ||
        c.idNumber.toLowerCase().includes(query) ||
        c.drug.toLowerCase().includes(query)
      );
      renderClaims(result);
    }

    function confirmDelete() {
      if (confirm('æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦åˆªé™¤æ­¤ç”³è«‹æ¡ˆä»¶å—ï¼Ÿ')) {
        alert('ç”³è«‹æ¡ˆä»¶å·²åˆªé™¤');
        applyFilters();
      }
    }

    // Set sidebar active state based on URL
    function setSidebarActive() {
      const urlParams = new URLSearchParams(window.location.search);
      const status = urlParams.get('status');

      if (status === 'draft') {
        document.getElementById('nav-my-drafts').classList.add('active');
        document.getElementById('page-title').textContent = 'æˆ‘çš„è‰ç¨¿';
        // Also select the draft tab
        const draftTab = document.querySelector('[data-status="è‰ç¨¿"]');
        if (draftTab) {
          selectTab(draftTab);
        }
      } else {
        document.getElementById('nav-claim-list').classList.add('active');
      }
    }

    // Initialize page
    const user = displayUserInfo();
    if (user) {
      setSidebarActive();
      applyFilters();
    }
  </script>
</body>
</html>
