# language: zh-TW
@claim @form
功能: 癌症用藥事前審查申請表單
  作為一個醫療人員
  我想要能夠填寫完整的申請表單
  以便進行癌症用藥事前審查

  背景:
    假設 我已經登入為 "doctor01"
    並且 資料庫中存在以下病人:
      | 病歷號    | 身分證字號   | 姓名   | 性別 | 出生日期   |
      | 1234567   | E125123456   | 測試病人 | M    | 1995-12-09 |
    並且 資料庫中存在以下藥品:
      | 藥品代碼     | 藥品名稱                           |
      | KC01065221   | Herceptin SC                       |
      | KC01065222   | Kadcyla (Ado-trastuzumab Emtansine) |
      | KC01065223   | Perjeta (Pertuzumab)               |
      | KC01065224   | Phesgo                             |

  # =============================================================================
  # 申請表單 Tab 結構
  # =============================================================================

  @tabs @happy-path
  場景: 申請表單具有六個標籤頁
    當 我在新增申請案頁面
    那麼 我應該看到以下標籤頁:
      | 標籤頁     |
      | 病歷摘要   |
      | 檢驗結果   |
      | 附件摘要   |
      | 附件-其他  |
      | 給付規定   |
      | 補充附件   |

  場景: 預設顯示病歷摘要標籤頁
    當 我在新增申請案頁面
    那麼 病歷摘要標籤頁應該為選中狀態
    並且 我應該看到病歷摘要表單

  場景: 切換標籤頁保留已填寫資料
    當 我在病歷摘要標籤頁填寫部分資料
    並且 我切換到檢驗結果標籤頁
    並且 我再切換回病歷摘要標籤頁
    那麼 之前填寫的資料應該仍然保留

  # =============================================================================
  # 病歷摘要標籤頁
  # =============================================================================

  @medical-summary @happy-path
  場景: 填寫病歷摘要基本資料
    當 我在病歷摘要標籤頁
    並且 我選擇門診/住院為 "門診"
    並且 我填寫以下病人基本資料:
      | 欄位       | 值           |
      | 姓名       | 測試病人     |
      | 身分證字號 | E125123456   |
      | 病歷號     | 1234567      |
      | 性別       | M            |
      | 出生年月日 | 1995-12-09   |
    那麼 年齡欄位應該自動計算並顯示

  場景大綱: 門診/住院選擇
    當 我在病歷摘要標籤頁
    並且 我選擇門診/住院為 "<類型>"
    那麼 門診/住院欄位應該顯示 "<類型>"

    例子:
      | 類型 |
      | 門診 |
      | 住院 |

  場景大綱: 申請類別選擇
    當 我在病歷摘要標籤頁
    並且 我選擇申請類別為 "<類別>"
    那麼 申請類別欄位應該顯示 "<類別>"

    例子:
      | 類別       |
      | 送核       |
      | 補件       |
      | 申復       |
      | 爭議審議   |
      | 資料異動   |

  場景大綱: 目前病患病況選擇
    當 我在病歷摘要標籤頁
    並且 我選擇目前病患病況為 "<病況>"
    那麼 目前病患病況欄位應該顯示 "<病況>"

    例子:
      | 病況               |
      | 疾病局部復發       |
      | 遠處轉移           |
      | 局部晚期性疾病     |
      | 無法手術切除疾病   |
      | 早期乳癌           |
      | 曾接受化療及其時間 |
      | 其他               |

  場景: 選擇其他病況時需填寫描述
    當 我在病歷摘要標籤頁
    並且 我選擇目前病患病況為 "其他"
    那麼 其他病況描述欄位應該變為必填

  場景: 填寫 ICD-10-CM 代碼
    當 我在病歷摘要標籤頁
    並且 我在 ICD-10-CM 代碼查詢器輸入 "C50"
    那麼 我應該看到相關的 ICD 代碼建議
    當 我選擇代碼 "G009"
    那麼 申請疾病別應該顯示 "G009"

  場景: 清空申請疾病別
    假設 我已選擇疾病別 "G009"
    當 我點擊 "一鍵清空申請疾病別" 按鈕
    那麼 申請疾病別應該被清空

  # =============================================================================
  # 申請品項
  # =============================================================================

  @application-items
  場景: 選擇乳癌藥品
    當 我在病歷摘要標籤頁的申請品項區塊
    並且 我填寫體重為 "70" kg
    並且 我選擇藥品名稱及代碼為 "Trastuzumab"
    那麼 應該顯示藥品的詳細資訊

  場景大綱: 乳癌藥品選項
    當 我在申請品項區塊
    那麼 藥品名稱及代碼下拉選單應該包含 "<藥品>"

    例子:
      | 藥品                            |
      | Trastuzumab                     |
      | Kadcyla (Ado-trastuzumab Emtansine) |
      | Perjeta (Pertuzumab)            |
      | Phesgo                          |

  場景: 填寫藥品使用日期
    當 我在申請品項區塊
    並且 我選擇藥品名稱及代碼為 "Trastuzumab"
    並且 我填寫使用日期起為 "2026-02-04"
    並且 我填寫使用日期訖為 "2026-10-04"
    那麼 使用日期應該被記錄

  場景: 新增藥品到申請品項表格
    當 我在申請品項區塊
    並且 我完整填寫藥品資訊並確認
    那麼 申請品項表格應該新增一筆記錄
    並且 表格應該顯示:
      | 欄位           |
      | 藥品名稱及代碼 |
      | 療程劑量 (mg)  |
      | 申請數量(瓶)   |
      | 使用日期(起)   |
      | 使用日期(訖)   |

  場景: 刪除已新增的藥品品項
    假設 申請品項表格已有一筆藥品記錄
    當 我點擊該藥品的刪除按鈕
    那麼 該藥品應該從表格中移除

  場景: 填寫手術日期
    當 我在申請品項區塊
    並且 我填寫手術日期為 "2026-01-15"
    那麼 手術日期欄位應該顯示 "2026-01-15"

  # =============================================================================
  # 申請醫師資訊
  # =============================================================================

  @physician-info
  場景: 填寫申請醫師資訊
    當 我在病歷摘要標籤頁
    並且 我填寫申請醫師為 "洪主任"
    並且 我填寫申請醫師身分證為 "A123456789"
    那麼 申請醫師資訊應該被記錄

  場景: 申請醫師自動帶入登入醫師資訊
    當 我在新增申請案頁面
    那麼 申請醫師欄位應該自動帶入目前登入醫師的姓名

  # =============================================================================
  # 病歷說明
  # =============================================================================

  @medical-note
  場景: 填寫病歷說明
    當 我在病歷摘要標籤頁
    並且 我在病歷說明欄位輸入詳細的病歷摘要
    那麼 病歷說明應該被記錄

  場景: 使用常用字範本
    當 我在病歷摘要標籤頁
    並且 我在常用字下拉選單選擇一個範本
    那麼 範本內容應該被插入到病歷說明欄位

  # =============================================================================
  # 檢驗結果標籤頁
  # =============================================================================

  @lab-results
  場景: 上傳檢驗結果檔案
    當 我在檢驗結果標籤頁
    並且 我選擇檢驗結果類別為 "電腦斷層"
    並且 我填寫檢查日期為 "2026-02-02"
    並且 我上傳一個檢驗結果檔案
    那麼 檔案應該被成功上傳
    並且 電腦斷層的檔案數量應該增加 1

  場景大綱: 檢驗結果類別選擇
    當 我在檢驗結果標籤頁
    那麼 檢驗結果類別下拉選單應該包含 "<類別>"

    例子:
      | 類別               |
      | 電腦斷層           |
      | 超音波檢查         |
      | 其他影像證據       |
      | 病理報告或細胞學報告 |
      | 腫瘤標誌類別       |
      | 其他               |

  場景: 顯示各類別已上傳檔案數量
    當 我在檢驗結果標籤頁
    那麼 我應該看到各檢驗結果類別的上傳檔案數量統計表

  場景: 預覽已上傳的檢驗結果檔案
    假設 我已上傳一個圖片檔案
    當 我在檢驗結果標籤頁
    那麼 我應該看到該圖片的縮圖預覽
    並且 我應該看到檔案名稱和上傳日期

  場景: 刪除已上傳的檢驗結果檔案
    假設 我已上傳一個檢驗結果檔案
    當 我點擊該檔案的刪除按鈕
    那麼 該檔案應該被移除

  # =============================================================================
  # 附件摘要標籤頁
  # =============================================================================

  @attachment-summary
  場景: 上傳病患同意書
    當 我在附件摘要標籤頁
    並且 我填寫同意書簽署日期為 "2026-02-02"
    並且 我上傳病患同意書檔案
    那麼 病患同意書應該被成功上傳

  # =============================================================================
  # 附件-其他標籤頁
  # =============================================================================

  @other-attachments
  場景: 上傳手寫病摘掃描
    當 我在附件-其他標籤頁
    並且 我填寫手寫病摘日期為 "2026-02-02"
    並且 我上傳手寫病摘掃描檔案
    那麼 手寫病摘掃描應該被成功上傳

  場景: 上傳其他附件
    當 我在附件-其他標籤頁
    並且 我填寫其他日期為 "2026-02-02"
    並且 我上傳其他附件檔案
    那麼 其他附件應該被成功上傳

  # =============================================================================
  # 給付規定標籤頁
  # =============================================================================

  @payment-rules
  場景: 顯示注意事項
    當 我在給付規定標籤頁
    那麼 我應該看到注意事項列表
    並且 注意事項應該包含:
      | 內容                                                     |
      | 本申請書限一人一案                                       |
      | 應事前審查之項目未依規定事前申請核准者，不予給付費用     |

  場景: 顯示藥品給付規定
    當 我在給付規定標籤頁
    那麼 我應該看到該藥品的健保給付規定內容

  # =============================================================================
  # 補充附件標籤頁
  # =============================================================================

  @supplementary-attachments
  場景: 上傳補充附件
    當 我在補充附件標籤頁
    並且 我上傳一個補充附件檔案
    那麼 補充附件應該被成功上傳

  # =============================================================================
  # 儲存與送出
  # =============================================================================

  @save-submit
  場景: 暫時儲存為草稿
    當 我填寫完部分申請資料
    並且 我點擊 "暫時儲存 (草稿)" 按鈕
    那麼 我應該看到成功訊息
    並且 案件狀態應該為 "草稿"

  場景: 確認送出待審核
    當 我填寫完整的申請資料
    並且 我點擊 "確認送出 (待審核)" 按鈕
    那麼 我應該看到成功訊息
    並且 案件狀態應該為 "待審核"

  場景: 送出時驗證必填欄位
    當 我在病歷摘要標籤頁
    並且 我未填寫必填欄位
    並且 我點擊 "確認送出 (待審核)" 按鈕
    那麼 我應該看到錯誤訊息提示必填欄位

  # =============================================================================
  # 乳癌用藥時間限制
  # =============================================================================

  @breast-cancer-rules
  場景: 顯示乳癌用藥申請週期提示
    當 我在新增申請案頁面
    那麼 我應該看到用藥申請週期提示:
      | 類型       | 週期     |
      | 早期乳癌   | 每24週   |
      | 晚期乳癌   | 每18週   |
      | 使用Kadcyla | 每12週  |

  # =============================================================================
  # 編輯現有案件
  # =============================================================================

  @edit-case
  場景: 編輯草稿案件
    假設 存在草稿狀態的案件
    當 我點擊該案件的編輯按鈕
    那麼 我應該看到已填寫的申請表單
    並且 我可以修改表單內容

  場景: 無法編輯已送審案件
    假設 存在待審核或更後狀態的案件
    當 我嘗試編輯該案件
    那麼 編輯功能應該被停用
    或者 我應該看到提示訊息說明無法編輯

  # =============================================================================
  # 表單驗證
  # =============================================================================

  @validation
  場景: 身分證字號格式驗證
    當 我在病歷摘要標籤頁
    並且 我填寫身分證字號為 "INVALID"
    那麼 我應該看到錯誤訊息 "請填身分證字號共十碼(前一碼為大寫英文字母)"

  場景: 性別格式驗證
    當 我在病歷摘要標籤頁
    並且 我填寫性別為 "X"
    那麼 我應該看到錯誤訊息 "請輸入 M / F"

  場景: 日期邏輯驗證
    當 我在申請品項區塊
    並且 我填寫使用日期起為 "2026-10-04"
    並且 我填寫使用日期訖為 "2026-02-04"
    那麼 我應該看到錯誤訊息 "使用日期訖不得早於使用日期起"
