# language: zh-TW
@claim @crud
功能: 申請案件管理
  作為一個醫療人員
  我想要能夠建立、查看、修改和刪除申請案件
  以便進行癌症用藥事前審查

  背景:
    假設 我已經登入為 "doctor01"
    並且 資料庫中存在以下病人:
      | 病歷號    | 姓名     | 身分證字號   |
      | 1234567   | 測試病人 | E125123456   |
      | 2345678   | 王小明   | A123456789   |
    並且 資料庫中存在以下醫師:
      | 帳號       | 姓名   | 科別   |
      | doctor01   | 洪主任 | 乳癌   |

  # =============================================================================
  # 建立申請案件
  # =============================================================================

  @create @happy-path
  場景: 成功建立新的申請案件
    當 我在側邊選單點擊 "新增申請案"
    並且 我填寫以下案件基本資料:
      | 欄位           | 值               |
      | 門診/住院      | 門診             |
      | 姓名           | 測試病人         |
      | 身分證字號     | E125123456       |
      | 病歷號         | 1234567          |
      | 性別           | M                |
      | 出生年月日     | 1995-12-09       |
      | 申請類別       | 送核             |
      | 目前病患病況   | 局部晚期性疾病   |
      | 申請次數       | 1                |
    並且 我點擊 "暫時儲存 (草稿)" 按鈕
    那麼 我應該看到成功訊息
    並且 案件狀態應該為 "草稿"

  場景: 從病人資料管理進入新增申請案
    當 我在病人資料管理頁面
    並且 我點擊病人 "測試病人" 的 "更多" 按鈕
    那麼 我應該看到該病人的申請案歷史記錄

  場景大綱: 申請類別選項
    當 我在新增申請案頁面
    並且 我選擇申請類別為 "<申請類別>"
    那麼 申請類別欄位應該顯示 "<申請類別>"

    例子:
      | 申請類別   |
      | 送核       |
      | 補件       |
      | 申復       |
      | 爭議審議   |
      | 資料異動   |

  場景: 建立補件案件需填寫原案件資訊
    當 我在新增申請案頁面
    並且 我選擇申請類別為 "補件"
    那麼 系統應該要求提供原申請案件的相關資訊

  場景: 建立申復案件需填寫原案件資訊
    當 我在新增申請案頁面
    並且 我選擇申請類別為 "申復"
    那麼 系統應該要求提供原申請案件的相關資訊

  場景: 建立案件缺少必填欄位
    當 我在新增申請案頁面
    並且 我只填寫病人姓名
    並且 我點擊 "確認送出 (待審核)" 按鈕
    那麼 我應該看到錯誤訊息提示必填欄位未填寫

  # =============================================================================
  # 查看申請案件
  # =============================================================================

  @read
  場景: 查看案件詳情
    假設 存在以下申請案件:
      | 病歷號    | 姓名     | 疾病別 | 狀態 |
      | 1234567   | 測試病人 | G009   | 草稿 |
    當 我在申請案件管理頁面
    並且 我點擊該案件的 "編輯" 按鈕
    那麼 我應該看到案件詳情表單
    並且 表單應該顯示各標籤頁:
      | 標籤頁     |
      | 病歷摘要   |
      | 檢驗結果   |
      | 附件摘要   |
      | 附件-其他  |
      | 給付規定   |
      | 補充附件   |

  場景: 從病人資料管理查看歷史案件
    當 我在病人資料管理頁面
    並且 我點擊病人 "測試病人" 的 "更多" 按鈕
    那麼 我應該看到申請表歷史記錄頁面
    並且 頁面應該顯示該病人的所有申請案件
    並且 表格應該包含以下欄位:
      | 欄位         |
      | 申請類別     |
      | 申請次數     |
      | 疾病別       |
      | 申請藥品     |
      | 申請日期     |
      | 影像學檢查   |
      | 送審日期     |
      | 通過日期     |
      | 續件日期     |
      | 未通過日期   |
      | 備註         |
      | 狀態         |

  # =============================================================================
  # 修改申請案件
  # =============================================================================

  @update @happy-path
  場景: 修改草稿狀態的案件
    假設 存在草稿狀態的案件
    當 我在申請案件管理頁面
    並且 我在草稿標籤頁找到該案件
    並且 我點擊編輯按鈕
    並且 我修改申請次數為 "2"
    並且 我點擊 "暫時儲存 (草稿)" 按鈕
    那麼 我應該看到成功訊息
    並且 案件的申請次數應該為 "2"

  場景: 無法修改已送審的案件
    假設 存在待審核狀態的案件
    當 我嘗試編輯該案件
    那麼 編輯功能應該被限制
    或者 我應該看到訊息 "已送審的案件無法修改"

  場景: 草稿案件送出待審核
    假設 存在草稿狀態且資料完整的案件
    當 我在該案件的編輯頁面
    並且 我點擊 "確認送出 (待審核)" 按鈕
    那麼 我應該看到成功訊息
    並且 案件狀態應該變更為 "待審核"

  # =============================================================================
  # 刪除申請案件
  # =============================================================================

  @delete
  場景: 刪除草稿狀態的案件
    假設 存在草稿狀態的案件
    當 我在申請案件管理頁面的草稿標籤頁
    並且 我點擊該案件的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "申請案件已刪除"
    並且 案件列表不應該包含該案件

  場景: 無法刪除已送審的案件
    假設 存在待審核狀態的案件
    當 我嘗試刪除該案件
    那麼 刪除按鈕應該被停用
    或者 我應該看到錯誤訊息 "已送審的案件無法刪除"

  場景: 刪除案件需要確認
    當 我點擊案件的刪除按鈕
    那麼 我應該看到確認對話框
    並且 對話框應該警告 "此操作無法復原"
    當 我點擊取消
    那麼 案件應該仍存在於系統中

  # =============================================================================
  # 案件狀態流程
  # =============================================================================

  @workflow
  場景: 案件狀態流程 - 草稿到待審核
    假設 存在草稿狀態的案件
    當 我完成所有必填資料
    並且 我點擊 "確認送出 (待審核)" 按鈕
    那麼 案件狀態應該變更為 "待審核"

  場景: 案件狀態流程 - 待審核到送審中
    假設 存在待審核狀態的案件
    當 案件被系統送出審查
    那麼 案件狀態應該變更為 "送審中"

  場景: 案件狀態流程 - 送審中到通過
    假設 存在送審中狀態的案件
    當 案件審查通過
    那麼 案件狀態應該變更為 "通過"
    並且 通過日期應該被記錄

  場景: 案件狀態流程 - 送審中到未通過
    假設 存在送審中狀態的案件
    當 案件審查未通過
    那麼 案件狀態應該變更為 "未通過"
    並且 未通過日期應該被記錄

  場景: 案件狀態流程 - 通過案件續件提醒
    假設 存在通過狀態的案件
    當 案件即將到期需要續件
    那麼 案件應該出現在 "續件提醒" 標籤頁

  場景: 案件狀態流程 - 結案
    假設 存在已完成所有流程的案件
    當 案件被標記為結案
    那麼 案件狀態應該變更為 "結案"
