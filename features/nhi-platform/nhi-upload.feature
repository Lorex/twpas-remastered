# language: zh-TW
@nhi-platform @upload
功能: 健保平台調閱與上傳
  作為一個醫療人員
  我想要能夠調閱和上傳申報資料至健保平台
  以便完成事前審查申報程序

  背景:
    假設 我已經登入為 "doctor01"
    並且 健保傳輸平台服務已連線
    並且 存在已完成的申報案件 "CASE-001" 包含:
      | 項目         | 內容              |
      | 狀態         | 待送審            |
      | FHIR Bundle  | 已轉換完成        |
      | 附件數量     | 3 (1 PDF, 2 PNG)  |

  # =============================================================================
  # 調閱 FHIR 資料
  # =============================================================================

  @fetch-fhir
  場景: 調閱案件的 FHIR Bundle
    當 我在案件 "CASE-001" 的詳情頁面
    並且 我點擊 "FHIR 預覽" 按鈕
    那麼 系統應該從 FHIR Server 調閱 Bundle
    並且 我應該看到 FHIR Bundle 的內容
    並且 內容應該以可讀格式顯示

  場景: 調閱案件的個別 FHIR 資源
    當 我在案件 "CASE-001" 的 FHIR 預覽頁面
    並且 我展開 Claim 資源
    那麼 我應該看到 Claim 的詳細內容
    並且 我可以展開其他資源查看

  場景: 下載 FHIR Bundle JSON
    當 我在案件 "CASE-001" 的 FHIR 預覽頁面
    並且 我點擊 "下載 JSON" 按鈕
    那麼 系統應該下載一個 JSON 檔案
    並且 檔案名稱應該為 "TWPAS-CASE-001-{timestamp}.json"
    並且 檔案內容應該為完整的 FHIR Bundle

  場景: FHIR Server 連線失敗
    假設 FHIR Server 暫時不可用
    當 我嘗試調閱案件 "CASE-001" 的 FHIR Bundle
    那麼 我應該看到錯誤訊息 "無法連線至 FHIR Server"
    並且 系統應該提供重試選項

  # =============================================================================
  # 調閱附件
  # =============================================================================

  @fetch-attachments
  場景: 調閱案件的附件列表
    當 我在案件 "CASE-001" 的附件頁面
    那麼 我應該看到附件列表包含 3 個檔案
    並且 列表應該顯示:
      | 檔案名稱     | 類型  | 大小    |
      | report.pdf   | PDF   | 2.5 MB  |
      | scan1.png    | PNG   | 1.2 MB  |
      | scan2.png    | PNG   | 1.5 MB  |

  場景: 預覽 PDF 附件
    當 我點擊附件 "report.pdf" 的預覽按鈕
    那麼 系統應該開啟 PDF 檢視器
    並且 我應該能夠瀏覽 PDF 內容

  場景: 預覽圖片附件
    當 我點擊附件 "scan1.png" 的預覽按鈕
    那麼 系統應該開啟圖片檢視器
    並且 我應該能夠放大縮小圖片

  場景: 下載個別附件
    當 我點擊附件 "report.pdf" 的下載按鈕
    那麼 系統應該下載該檔案

  # =============================================================================
  # 附件打包
  # =============================================================================

  @package-attachments
  場景: 打包所有附件為 ZIP
    當 我在案件 "CASE-001" 的附件頁面
    並且 我點擊 "打包下載" 按鈕
    那麼 系統應該產生一個 ZIP 檔案
    並且 ZIP 應該包含所有附件:
      | 檔案名稱     |
      | report.pdf   |
      | scan1.png    |
      | scan2.png    |
    並且 系統應該下載該 ZIP 檔案
    並且 檔案名稱應該為 "TWPAS-CASE-001-attachments.zip"

  場景: 打包附件包含 FHIR Bundle
    當 我在案件 "CASE-001" 的附件頁面
    並且 我勾選 "包含 FHIR Bundle"
    並且 我點擊 "打包下載" 按鈕
    那麼 ZIP 應該包含:
      | 檔案名稱     |
      | bundle.json  |
      | report.pdf   |
      | scan1.png    |
      | scan2.png    |

  場景: 大型附件打包進度顯示
    假設 案件有多個大型附件 (總計 > 10 MB)
    當 我點擊 "打包下載" 按鈕
    那麼 我應該看到打包進度指示器
    並且 進度應該顯示百分比

  # =============================================================================
  # 上傳至健保平台
  # =============================================================================

  @upload
  場景: 上傳申報資料至健保平台
    當 我在案件 "CASE-001" 的送審頁面
    並且 案件驗證已通過
    並且 我點擊 "送審" 按鈕
    並且 我確認送審操作
    那麼 系統應該:
      | 步驟                         |
      | 打包 FHIR Bundle             |
      | 打包所有附件                 |
      | 上傳至健保傳輸平台           |
    並且 我應該看到上傳進度
    並且 上傳成功後應該顯示受理編號
    並且 案件狀態應該更新為 "已送審"

  場景: 上傳前驗證失敗
    假設 案件 "CASE-001" 有驗證錯誤
    當 我嘗試送審案件
    那麼 我應該看到驗證錯誤列表
    並且 送審按鈕應該被停用
    並且 我應該被提示修正錯誤

  場景: 上傳過程中網路中斷
    假設 網路連線不穩定
    當 我送審案件 "CASE-001"
    並且 上傳過程中網路中斷
    那麼 我應該看到錯誤訊息 "網路連線中斷，請稍後重試"
    並且 案件狀態應該維持 "待送審"
    並且 系統應該記錄失敗日誌

  場景: 上傳後健保平台回傳錯誤
    假設 健保平台回傳錯誤代碼 "E001"
    當 我送審案件 "CASE-001"
    那麼 我應該看到錯誤訊息包含錯誤代碼 "E001"
    並且 我應該看到錯誤說明
    並且 案件狀態應該維持 "待送審"

  場景: 查看上傳歷史紀錄
    當 我在案件 "CASE-001" 的送審頁面
    並且 我點擊 "上傳紀錄" 按鈕
    那麼 我應該看到所有上傳嘗試的紀錄
    並且 紀錄應該包含:
      | 欄位       |
      | 上傳時間   |
      | 上傳者     |
      | 狀態       |
      | 回應訊息   |

  # =============================================================================
  # 查詢審查結果
  # =============================================================================

  @query-result
  場景: 查詢審查結果
    假設 案件 "CASE-001" 已送審
    當 我點擊 "查詢結果" 按鈕
    那麼 系統應該向健保平台查詢審查狀態
    並且 我應該看到審查結果

  場景: 審查結果 - 核准
    假設 案件 "CASE-001" 已被核准
    當 我查詢審查結果
    那麼 審查狀態應該顯示 "核准"
    並且 我應該看到核准的品項明細
    並且 我應該看到核准效期

  場景: 審查結果 - 駁回
    假設 案件 "CASE-001" 已被駁回
    當 我查詢審查結果
    那麼 審查狀態應該顯示 "駁回"
    並且 我應該看到駁回原因
    並且 我應該有申覆或重新申請的選項

  場景: 審查結果 - 補件
    假設 案件 "CASE-001" 需要補件
    當 我查詢審查結果
    那麼 審查狀態應該顯示 "補件中"
    並且 我應該看到需要補件的項目
    並且 我應該有上傳補件的選項

  場景: 審查結果 - 審核中
    假設 案件 "CASE-001" 仍在審核中
    當 我查詢審查結果
    那麼 審查狀態應該顯示 "審核中"
    並且 我應該看到預計審核完成時間

  場景: 批次查詢多筆審查結果
    假設 我有多筆已送審的案件
    當 我在案件列表頁面
    並且 我勾選多筆案件
    並且 我點擊 "批次查詢結果"
    那麼 系統應該查詢所有選取案件的審查結果
    並且 結果應該在列表中更新

  # =============================================================================
  # 補件上傳
  # =============================================================================

  @supplementary
  場景: 上傳補件資料
    假設 案件 "CASE-001" 狀態為 "補件中"
    當 我在案件詳情頁面
    並且 我點擊 "上傳補件" 按鈕
    並且 我上傳補件附件
    並且 我填寫補件說明
    並且 我點擊送出
    那麼 補件應該成功上傳至健保平台
    並且 系統應該顯示補件上傳紀錄
