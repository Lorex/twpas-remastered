# language: zh-TW
@genetic-info
功能: 基因資訊管理
  作為一個醫療人員
  我想要能夠填寫申報案件的基因資訊
  以便記錄基因檢測結果作為用藥依據

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 我在案件 "CASE-001" 的基因資訊頁面
    並且 資料庫中存在以下檢測機構:
      | 機構代碼 | 名稱             | 認證       |
      | LAB001   | 基因科技公司     | CAP/CLIA   |
      | LAB002   | 精準醫學中心     | CAP        |
      | LAB003   | 分子檢驗實驗室   | TAF        |

  # =============================================================================
  # 基因檢測資料
  # =============================================================================

  @genetic-test @happy-path
  場景: 新增基因檢測資料
    當 我點擊 "新增基因檢測" 按鈕
    並且 我填寫以下基因檢測資料:
      | 欄位             | 值                    |
      | 檢測類型         | 次世代定序面板 (NGS)  |
      | 檢體類型         | 組織                  |
      | 檢體採集日期     | 2024-01-10            |
      | 檢測日期         | 2024-01-15            |
      | 報告日期         | 2024-01-18            |
      | 基因符號         | EGFR                  |
      | 突變類型         | 點突變                |
      | 突變細節         | L858R                 |
      | VAF (%)          | 35.5                  |
      | 結果             | 陽性                  |
      | 結果判讀         | 建議使用 EGFR-TKI     |
      | 檢測機構         | 基因科技公司 (LAB001) |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "基因檢測資料已新增"
    並且 基因檢測列表應該包含此檢測

  場景: 選擇檢測機構
    當 我在新增基因檢測
    並且 我點擊檢測機構選擇欄位
    並且 我輸入 "基因" 進行搜尋
    那麼 我應該看到符合條件的機構列表
    並且 列表應該顯示機構的認證資訊
    當 我選擇 "基因科技公司"
    那麼 檢測機構欄位應該顯示 "基因科技公司 (LAB001)"

  場景大綱: 基因檢測類型選擇
    當 我在新增基因檢測
    並且 我選擇檢測類型為 "<檢測類型>"
    那麼 檢測類型欄位應該顯示 "<檢測類型>"

    例子:
      | 檢測類型               |
      | 次世代定序面板 (NGS)   |
      | PCR                    |
      | FISH 螢光原位雜交      |
      | 免疫組織化學染色 (IHC) |
      | 液態切片               |
      | 全外顯子定序           |
      | 腫瘤突變負荷 (TMB)     |
      | 微衛星不穩定 (MSI)     |

  場景大綱: 檢體類型選擇
    當 我在新增基因檢測
    並且 我選擇檢體類型為 "<檢體類型>"
    那麼 檢體類型欄位應該顯示 "<檢體類型>"

    例子:
      | 檢體類型   |
      | 組織       |
      | 血液       |
      | 血漿       |
      | 骨髓       |
      | 腦脊髓液   |
      | 腹水       |
      | 胸水       |

  場景大綱: 突變類型選擇
    當 我在新增基因檢測
    並且 我選擇突變類型為 "<突變類型>"
    那麼 突變類型欄位應該顯示 "<突變類型>"

    例子:
      | 突變類型     |
      | 點突變       |
      | 插入         |
      | 缺失         |
      | 融合         |
      | 擴增         |
      | 重排         |
      | 拷貝數變異   |

  場景大綱: 基因檢測結果選擇
    當 我在新增基因檢測
    並且 我選擇結果為 "<結果>"
    那麼 結果欄位應該顯示 "<結果>"

    例子:
      | 結果     |
      | 陽性     |
      | 陰性     |
      | 不確定   |
      | 未檢出   |
      | 檢出     |
      | 待判讀   |

  # =============================================================================
  # 常見基因突變
  # =============================================================================

  @common-mutations
  場景: 記錄 EGFR 突變
    當 我新增基因檢測資料
    並且 我選擇基因符號為 "EGFR"
    那麼 系統應該提示常見的 EGFR 突變:
      | 突變     |
      | L858R    |
      | T790M    |
      | exon 19 deletion |
      | exon 20 insertion |

  場景: 記錄 ALK 融合基因
    當 我新增基因檢測資料
    並且 我選擇基因符號為 "ALK"
    並且 我選擇突變類型為 "融合"
    那麼 系統應該提示常見的融合夥伴:
      | 融合夥伴 |
      | EML4     |
      | KIF5B    |
      | TFG      |

  場景: 記錄 BRAF 突變
    當 我新增基因檢測資料
    並且 我選擇基因符號為 "BRAF"
    那麼 系統應該提示常見的 BRAF 突變:
      | 突變     |
      | V600E    |
      | V600K    |

  # =============================================================================
  # 附件管理
  # =============================================================================

  @attachment
  場景: 上傳基因報告 PDF 附件
    當 我在新增基因檢測
    並且 我點擊 "上傳報告" 按鈕
    並且 我選擇一個 PDF 檔案
    那麼 附件應該上傳成功
    並且 我應該看到 PDF 預覽圖示
    並且 附件路徑應該被記錄

  場景: 基因報告附件格式限制
    當 我在新增基因檢測
    並且 我嘗試上傳一個 .xlsx 檔案
    那麼 我應該看到錯誤訊息 "不支援的檔案格式，請上傳 PDF 檔案"

  場景: 查看已上傳的基因報告
    假設 基因檢測已有上傳的報告附件
    當 我點擊附件的查看按鈕
    那麼 系統應該開啟 PDF 檢視器
    或者 附件應該在新分頁開啟

  # =============================================================================
  # 多筆基因檢測
  # =============================================================================

  @multiple-tests
  場景: 新增多筆不同基因的檢測
    當 我新增以下基因檢測:
      | 基因符號 | 突變類型 | 結果   |
      | EGFR     | 點突變   | 陽性   |
      | ALK      | 融合     | 陰性   |
      | ROS1     | 重排     | 陰性   |
    那麼 基因檢測列表應該有 3 筆記錄

  場景: 同一基因多次檢測
    當 我新增以下基因檢測:
      | 基因符號 | 檢測日期   | 結果   | 說明           |
      | EGFR     | 2024-01-15 | 陽性   | 初始檢測       |
      | EGFR     | 2024-06-15 | 陽性   | 追蹤檢測-T790M |
    那麼 基因檢測列表應該有 2 筆 EGFR 記錄
    並且 系統應該依檢測日期排序顯示

  # =============================================================================
  # 編輯與刪除
  # =============================================================================

  @edit-delete
  場景: 編輯已存在的基因檢測
    假設 案件已有一筆 EGFR 基因檢測
    當 我點擊該基因檢測的編輯按鈕
    並且 我修改結果判讀為 "更新後的判讀"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "基因檢測資料已更新"

  場景: 刪除基因檢測
    假設 案件已有一筆基因檢測
    當 我點擊該基因檢測的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "基因檢測資料已刪除"
    並且 基因檢測列表應該為空

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 基因檢測必填欄位驗證
    當 我在新增基因檢測
    並且 我只填寫基因符號
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "檢測類型為必填"
    並且 我應該看到錯誤訊息包含 "檢體類型為必填"
    並且 我應該看到錯誤訊息包含 "檢測日期為必填"
    並且 我應該看到錯誤訊息包含 "結果為必填"

  場景: VAF 數值範圍驗證
    當 我在新增基因檢測
    並且 我填寫 VAF 為 "150"
    那麼 我應該看到錯誤訊息 "VAF 必須介於 0 到 100 之間"
