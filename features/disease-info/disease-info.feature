# language: zh-TW
@disease-info
功能: 疾病資訊管理
  作為一個醫療人員
  我想要能夠填寫申報案件的疾病資訊
  以便完整記錄影像報告、癌症分期和檢查報告

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 我在案件 "CASE-001" 的疾病資訊頁面
    並且 資料庫中存在以下醫師:
      | 證書字號 | 姓名   | 專科     |
      | DOC001   | 張醫師 | 放射科   |
      | DOC002   | 李醫師 | 病理科   |
      | DOC003   | 王醫師 | 腫瘤科   |

  # =============================================================================
  # 影像報告
  # =============================================================================

  @imaging-report @happy-path
  場景: 新增影像報告
    當 我點擊 "新增影像報告" 按鈕
    並且 我填寫以下影像報告資料:
      | 欄位         | 值                           |
      | 影像類型     | 電腦斷層 (CT)                |
      | 檢查部位     | 肺部                         |
      | 報告日期     | 2024-01-15                   |
      | 發現         | 右上葉可見 2.5cm 腫塊        |
      | 結論         | 高度懷疑為原發性肺癌         |
      | 簽發醫師     | 張醫師 (DOC001)              |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "影像報告已新增"
    並且 影像報告列表應該包含此報告

  場景: 選擇簽發影像報告醫師
    當 我在新增影像報告
    並且 我點擊簽發醫師選擇欄位
    並且 我輸入 "張" 進行搜尋
    那麼 我應該看到符合條件的醫師列表
    並且 列表應該顯示醫師的專科資訊
    當 我選擇 "張醫師"
    那麼 簽發醫師欄位應該顯示 "張醫師 (DOC001)"

  場景大綱: 影像類型選擇
    當 我在新增影像報告
    並且 我選擇影像類型為 "<影像類型>"
    那麼 影像類型欄位應該顯示 "<影像類型>"
    並且 對應的 ICD-10-PCS 代碼應該為 "<代碼>"

    例子:
      | 影像類型           | 代碼     |
      | 電腦斷層 (CT)      | BW230ZZ  |
      | 磁振造影 (MRI)     | BW33ZZZ  |
      | 正子造影 (PET-CT)  | CW30ZZZ  |
      | X光                | BW00ZZZ  |
      | 超音波             | BW40ZZZ  |

  場景: 上傳影像報告附件
    當 我在新增影像報告
    並且 我點擊 "上傳附件" 按鈕
    並且 我選擇一個 PNG 圖檔
    那麼 附件應該上傳成功
    並且 我應該看到附件預覽
    並且 附件路徑應該被記錄

  場景: 上傳多個影像報告附件
    當 我在新增影像報告
    並且 我上傳以下附件:
      | 檔案名稱      | 類型  |
      | scan1.png     | PNG   |
      | scan2.jpeg    | JPEG  |
    那麼 所有附件應該上傳成功
    並且 附件列表應該顯示 2 個檔案

  場景: 影像報告附件格式限制
    當 我在新增影像報告
    並且 我嘗試上傳一個 .doc 檔案
    那麼 我應該看到錯誤訊息 "不支援的檔案格式，請上傳 PNG、JPEG 或 PDF 檔案"

  # =============================================================================
  # 癌症分期
  # =============================================================================

  @cancer-staging @happy-path
  場景: 新增癌症分期資料
    當 我點擊 "新增癌症分期" 按鈕
    並且 我填寫以下癌症分期資料:
      | 欄位         | 值                    |
      | 分期系統     | AJCC 第 8 版          |
      | 臨床分期     | Stage IIIA            |
      | T 分期       | T2                    |
      | N 分期       | N2                    |
      | M 分期       | M0                    |
      | 評估日期     | 2024-01-20            |
      | 簽發醫師     | 王醫師 (DOC003)       |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "癌症分期已新增"

  場景大綱: 癌症分期系統選擇
    當 我在新增癌症分期
    並且 我選擇分期系統為 "<分期系統>"
    那麼 分期系統欄位應該顯示 "<分期系統>"
    並且 可選的分期結果應該符合該系統的定義

    例子:
      | 分期系統     |
      | AJCC 第 8 版 |
      | AJCC 第 7 版 |
      | FIGO         |
      | Ann Arbor    |
      | ISS          |

  場景: 使用 FIGO 分期系統 (婦科腫瘤)
    當 我在新增癌症分期
    並且 我選擇分期系統為 "FIGO"
    那麼 分期結果選項應該包含:
      | 分期結果 |
      | Stage I  |
      | Stage II |
      | Stage III|
      | Stage IV |
    並且 T/N/M 分期欄位應該被隱藏

  # =============================================================================
  # 檢查報告
  # =============================================================================

  @examination-report @happy-path
  場景: 新增檢查報告
    當 我點擊 "新增檢查報告" 按鈕
    並且 我填寫以下檢查報告資料:
      | 欄位         | 值                    |
      | 檢查類型     | 病理報告              |
      | 報告日期     | 2024-01-18            |
      | 檢體         | 肺部切片              |
      | 發現         | 非小細胞肺癌          |
      | 結論         | 腺癌, EGFR 突變陽性   |
      | 簽發醫師     | 李醫師 (DOC002)       |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "檢查報告已新增"

  場景大綱: 檢查類型選擇
    當 我在新增檢查報告
    並且 我選擇檢查類型為 "<檢查類型>"
    那麼 檢查類型欄位應該顯示 "<檢查類型>"

    例子:
      | 檢查類型     |
      | 病理報告     |
      | 切片報告     |
      | 細胞學報告   |
      | 內視鏡報告   |
      | 支氣管鏡報告 |
      | 大腸鏡報告   |

  場景: 上傳檢查報告 PDF 附件
    當 我在新增檢查報告
    並且 我點擊 "上傳附件" 按鈕
    並且 我選擇一個 PDF 檔案
    那麼 附件應該上傳成功
    並且 我應該看到 PDF 預覽圖示
    並且 附件路徑應該被記錄

  # =============================================================================
  # 疾病資訊總覽
  # =============================================================================

  @overview
  場景: 查看疾病資訊總覽
    假設 案件已填寫以下疾病資訊:
      | 類型       | 數量 |
      | 影像報告   | 2    |
      | 癌症分期   | 1    |
      | 檢查報告   | 1    |
    當 我在疾病資訊頁面
    那麼 我應該看到影像報告列表有 2 筆
    並且 我應該看到癌症分期列表有 1 筆
    並且 我應該看到檢查報告列表有 1 筆

  場景: 編輯已存在的影像報告
    假設 案件已有一筆影像報告
    當 我點擊該影像報告的編輯按鈕
    並且 我修改結論為 "更新後的結論"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "影像報告已更新"
    並且 影像報告的結論應該為 "更新後的結論"

  場景: 刪除疾病資訊項目
    假設 案件已有一筆影像報告
    當 我點擊該影像報告的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "影像報告已刪除"
    並且 影像報告列表應該為空

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 一般事前審查需填寫至少一項疾病資訊
    假設 案件的申報類別為 "新申請"
    並且 案件類別為 "癌症標靶治療"
    並且 診斷代碼不是 C90 或 C92 開頭
    當 案件未填寫任何疾病資訊
    並且 我嘗試送審案件
    那麼 我應該看到驗證錯誤 "需提供影像報告、檢查報告、基因資訊中至少一項"

  場景: C90/C92 診斷排除疾病資訊必填規則
    假設 案件的診斷代碼為 "C90.0"
    當 案件未填寫任何疾病資訊
    並且 我嘗試送審案件
    那麼 疾病資訊驗證應該通過
