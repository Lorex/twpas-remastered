# language: zh-TW
@outcome
功能: 結果資訊管理
  作為一個醫療人員
  我想要能夠填寫申報案件的結果資訊
  以便記錄治療後的疾病狀態評估

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 該案件已有治療資訊
    並且 我在案件 "CASE-001" 的結果資訊頁面

  # =============================================================================
  # 治療後疾病狀態評估
  # =============================================================================

  @treatment-response @happy-path
  場景: 新增治療後疾病狀態評估
    當 我點擊 "新增治療後評估" 按鈕
    並且 我填寫以下評估資料:
      | 欄位         | 值                    |
      | 評估日期     | 2024-03-01            |
      | 評估標準     | RECIST 1.1            |
      | 反應類別     | PR (部分反應)         |
      | 評估說明     | 腫瘤縮小 35%          |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "治療後評估已新增"
    並且 結果列表應該包含此評估記錄

  場景大綱: RECIST 1.1 反應類別
    當 我在新增治療後評估
    並且 我選擇評估標準為 "RECIST 1.1"
    並且 我選擇反應類別為 "<反應>"
    那麼 反應類別欄位應該顯示 "<反應>"
    並且 應該顯示反應說明 "<說明>"

    例子:
      | 反應                  | 說明                                     |
      | CR (完全反應)         | 所有目標病灶消失                         |
      | PR (部分反應)         | 目標病灶總和直徑減少至少 30%             |
      | SD (疾病穩定)         | 未達 PR 標準且未達 PD 標準               |
      | PD (疾病惡化)         | 目標病灶總和直徑增加至少 20% 或新病灶出現 |
      | NE (無法評估)         | 因故無法評估                             |

  場景大綱: iRECIST 反應類別 (免疫治療)
    假設 案件使用免疫治療藥物
    當 我在新增治療後評估
    並且 我選擇評估標準為 "iRECIST"
    並且 我選擇反應類別為 "<反應>"
    那麼 反應類別欄位應該顯示 "<反應>"

    例子:
      | 反應                      |
      | iCR (免疫完全反應)        |
      | iPR (免疫部分反應)        |
      | iSD (免疫疾病穩定)        |
      | iUPD (免疫未確認惡化)     |
      | iCPD (免疫確認惡化)       |

  場景大綱: 其他評估標準選擇
    當 我在新增治療後評估
    並且 我選擇評估標準為 "<標準>"
    那麼 系統應該載入對應的反應類別選項

    例子:
      | 標準                      |
      | RECIST 1.1                |
      | iRECIST                   |
      | mRECIST (肝細胞癌)        |
      | Choi 標準 (GIST)          |
      | Cheson 標準 (淋巴瘤)      |
      | IMWG 標準 (多發性骨髓瘤)  |
      | WHO 標準                  |

  # =============================================================================
  # 最佳反應記錄
  # =============================================================================

  @best-response
  場景: 記錄最佳反應
    假設 案件已有以下治療後評估記錄:
      | 評估日期   | 反應類別      |
      | 2024-02-01 | PR (部分反應) |
      | 2024-03-01 | CR (完全反應) |
      | 2024-04-01 | PR (部分反應) |
    當 我在結果資訊頁面
    那麼 系統應該顯示最佳反應為 "CR (完全反應)"
    並且 最佳反應日期應該為 "2024-03-01"

  場景: 標記最佳反應
    當 我在結果資訊頁面
    並且 我選擇一筆評估記錄
    並且 我點擊 "標記為最佳反應" 按鈕
    那麼 該記錄應該被標記為最佳反應
    並且 應該顯示最佳反應標籤

  # =============================================================================
  # 續用申請相關
  # =============================================================================

  @continuation
  場景: 續用申請需提供治療反應
    假設 案件的申報類別為 "續用申請"
    當 我在結果資訊頁面
    那麼 我應該看到提醒訊息 "續用申請需提供治療反應評估"

  場景: 驗證續用申請必要資料
    假設 案件的申報類別為 "續用申請"
    並且 案件沒有任何治療後評估記錄
    當 我嘗試提交案件
    那麼 我應該看到錯誤訊息 "續用申請需至少提供一筆治療反應評估"

  場景: 續用申請需顯示治療成效摘要
    假設 案件的申報類別為 "續用申請"
    並且 案件已有治療後評估記錄
    當 我在結果資訊頁面
    那麼 我應該看到治療成效摘要區塊
    並且 摘要應該包含:
      | 項目         |
      | 治療開始日期 |
      | 最佳反應     |
      | 目前反應     |
      | 疾病控制時間 |

  # =============================================================================
  # 疾病惡化處理
  # =============================================================================

  @progression
  場景: 記錄疾病惡化
    當 我點擊 "新增治療後評估" 按鈕
    並且 我選擇反應類別為 "PD (疾病惡化)"
    並且 我填寫以下惡化資料:
      | 欄位             | 值                    |
      | 惡化類型         | 新病灶出現            |
      | 惡化部位         | 肝臟                  |
      | 惡化說明         | 肝臟發現新轉移病灶    |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "治療後評估已新增"
    並且 應該顯示疾病惡化警示

  場景大綱: 疾病惡化類型
    當 我在新增治療後評估
    並且 我選擇反應類別為 "PD (疾病惡化)"
    那麼 我應該看到惡化類型選項:
      | 惡化類型           |
      | 目標病灶增大       |
      | 新病灶出現         |
      | 非目標病灶惡化     |

  場景: 疾病惡化後建議變更治療
    假設 案件最新評估為 "PD (疾病惡化)"
    當 我在結果資訊頁面
    那麼 系統應該顯示建議訊息 "建議評估是否需要變更治療方案"
    並且 應該提供 "申請療程變更" 連結

  # =============================================================================
  # 影像學評估細節
  # =============================================================================

  @imaging-assessment
  場景: 填寫影像學評估細節
    當 我點擊 "新增治療後評估" 按鈕
    並且 我選擇評估標準為 "RECIST 1.1"
    並且 我點擊 "新增目標病灶測量" 按鈕
    並且 我填寫以下病灶資料:
      | 病灶編號 | 部位   | 基準值 (mm) | 目前值 (mm) |
      | 1        | 肺右上葉 | 35          | 22          |
      | 2        | 肺左下葉 | 28          | 18          |
    那麼 目標病灶總和應該自動計算
    並且 變化百分比應該顯示為 "-36.5%"
    並且 系統應該建議反應類別為 "PR (部分反應)"

  場景: 非目標病灶評估
    當 我在新增治療後評估
    並且 我選擇評估標準為 "RECIST 1.1"
    並且 我在非目標病灶評估選擇 "CR (完全消失)"
    那麼 非目標病灶評估應該記錄為 "CR"

  場景大綱: 非目標病灶評估選項
    當 我在新增治療後評估
    並且 我選擇評估標準為 "RECIST 1.1"
    那麼 非目標病灶評估選項應該包含:
      | 評估結果           |
      | CR (完全消失)      |
      | Non-CR/Non-PD      |
      | PD (明確惡化)      |
      | NE (無法評估)      |

  # =============================================================================
  # 多筆評估記錄
  # =============================================================================

  @multiple
  場景: 新增多筆治療後評估
    當 我新增以下治療後評估:
      | 評估日期   | 評估標準   | 反應類別      |
      | 2024-02-01 | RECIST 1.1 | SD (疾病穩定) |
      | 2024-03-01 | RECIST 1.1 | PR (部分反應) |
      | 2024-04-01 | RECIST 1.1 | PR (部分反應) |
    那麼 結果列表應該有 3 筆記錄
    並且 記錄應該按評估日期排序

  場景: 顯示評估歷程時間軸
    假設 案件已有多筆治療後評估記錄
    當 我在結果資訊頁面
    並且 我點擊 "時間軸檢視" 按鈕
    那麼 我應該看到評估歷程時間軸
    並且 時間軸應該顯示各評估點的反應變化

  # =============================================================================
  # 編輯與刪除
  # =============================================================================

  @edit-delete
  場景: 編輯已存在的治療後評估
    假設 案件已有一筆治療後評估
    當 我點擊該評估的編輯按鈕
    並且 我修改反應類別為 "CR (完全反應)"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "治療後評估已更新"

  場景: 刪除治療後評估
    假設 案件已有一筆治療後評估
    當 我點擊該評估的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "治療後評估已刪除"
    並且 結果列表應該為空

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 治療後評估必填欄位驗證
    當 我在新增治療後評估
    並且 我只填寫評估日期
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "評估標準為必填"
    並且 我應該看到錯誤訊息包含 "反應類別為必填"

  場景: 評估日期不得早於治療開始日期
    假設 案件的治療開始日期為 "2024-02-01"
    當 我在新增治療後評估
    並且 我填寫評估日期為 "2024-01-15"
    那麼 我應該看到錯誤訊息 "評估日期不得早於治療開始日期"

  場景: 評估日期不得在未來
    當 我在新增治療後評估
    並且 我填寫評估日期為明天的日期
    那麼 我應該看到錯誤訊息 "評估日期不得為未來日期"

  # =============================================================================
  # 報表與統計
  # =============================================================================

  @reports
  場景: 產生治療反應摘要報表
    假設 案件已有完整的治療及評估記錄
    當 我在結果資訊頁面
    並且 我點擊 "產生摘要報表" 按鈕
    那麼 系統應該產生治療反應摘要報表
    並且 報表應該包含:
      | 項目           |
      | 病人基本資料   |
      | 治療方案       |
      | 評估歷程       |
      | 最佳反應       |
      | 目前狀態       |

  場景: 匯出治療反應數據
    假設 案件已有多筆治療後評估記錄
    當 我在結果資訊頁面
    並且 我點擊 "匯出數據" 按鈕
    那麼 系統應該下載包含所有評估數據的 CSV 檔案
