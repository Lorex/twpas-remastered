# language: zh-TW
@treatment
功能: 治療資訊管理
  作為一個醫療人員
  我想要能夠填寫申報案件的治療資訊
  以便記錄用藥品項和放射治療資料

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 我在案件 "CASE-001" 的治療資訊頁面
    並且 資料庫中存在以下藥物:
      | 健保碼        | 名稱                    | ATC 代碼 |
      | KC00961100    | IRESSA TAB 250MG        | L01EB01  |
      | KC00962100    | TARCEVA TAB 150MG       | L01EB02  |
      | KC01234100    | KEYTRUDA INJ 100MG      | L01FF02  |

  # =============================================================================
  # 用藥品項
  # =============================================================================

  @medication @happy-path
  場景: 新增用藥品項
    當 我點擊 "新增用藥品項" 按鈕
    並且 我填寫以下用藥資料:
      | 欄位         | 值                    |
      | 藥物         | IRESSA TAB 250MG      |
      | 劑量         | 250                   |
      | 劑量單位     | mg                    |
      | 頻率         | QD                    |
      | 給藥途徑     | 口服 (PO)             |
      | 用藥線別     | 第一線                |
      | 療程次數     | 1                     |
      | 療程天數     | D1-28                 |
      | 開始日期     | 2024-02-01            |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "用藥品項已新增"
    並且 用藥列表應該包含 "IRESSA TAB 250MG"

  場景: 搜尋並選擇藥物
    當 我在新增用藥品項
    並且 我在藥物欄位輸入 "IRESSA"
    那麼 我應該看到藥物搜尋結果
    並且 結果應該包含 "IRESSA TAB 250MG (KC00961100)"
    當 我選擇 "IRESSA TAB 250MG"
    那麼 藥物欄位應該顯示 "IRESSA TAB 250MG"
    並且 健保碼應該自動填入 "KC00961100"

  場景大綱: 用藥頻率選擇
    當 我在新增用藥品項
    並且 我選擇頻率為 "<頻率>"
    那麼 頻率欄位應該顯示 "<頻率>"

    例子:
      | 頻率     |
      | QD       |
      | BID      |
      | TID      |
      | QID      |
      | Q12H     |
      | Q8H      |
      | Q3W      |
      | Q4W      |
      | 每週一次 |

  場景大綱: 用藥線別選擇
    當 我在新增用藥品項
    並且 我選擇用藥線別為 "<線別>"
    那麼 用藥線別欄位應該顯示 "<線別>"

    例子:
      | 線別     |
      | 第一線   |
      | 第二線   |
      | 第三線   |
      | 第四線以上 |

  場景大綱: 給藥途徑選擇
    當 我在新增用藥品項
    並且 我選擇給藥途徑為 "<途徑>"
    那麼 給藥途徑欄位應該顯示 "<途徑>"

    例子:
      | 途徑     |
      | 口服 (PO)|
      | 靜脈注射 (IV) |
      | 皮下注射 (SC) |
      | 肌肉注射 (IM) |

  場景: 填寫療程天數使用週期格式
    當 我在新增用藥品項
    並且 我填寫療程天數為 "D1, D8, D15 / 每 28 天"
    那麼 系統應該接受此格式

  # =============================================================================
  # 放射治療
  # =============================================================================

  @radiotherapy @happy-path
  場景: 新增放射治療
    當 我點擊 "新增放射治療" 按鈕
    並且 我填寫以下放射治療資料:
      | 欄位         | 值                    |
      | 治療類型     | 體外放射治療 (EBRT)   |
      | 治療部位     | 肺部                  |
      | 總劑量       | 6000                  |
      | 劑量單位     | cGy                   |
      | 分次數       | 30                    |
      | 每次劑量     | 200                   |
      | 技術         | IMRT                  |
      | 開始日期     | 2024-02-15            |
      | 結束日期     | 2024-03-20            |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "放射治療已新增"
    並且 放射治療列表應該包含此記錄

  場景大綱: 放射治療類型選擇
    當 我在新增放射治療
    並且 我選擇治療類型為 "<類型>"
    那麼 治療類型欄位應該顯示 "<類型>"

    例子:
      | 類型                     |
      | 體外放射治療 (EBRT)      |
      | 近接治療 (Brachytherapy) |
      | 立體定位放射手術 (SRS)   |
      | 立體定位體部放射治療 (SBRT) |
      | 質子治療                 |

  場景: 放射治療部位從值集選擇
    當 我在新增放射治療
    並且 我點擊治療部位欄位
    那麼 我應該看到身體部位選項
    並且 選項應該來自 ICD-10-PCS 放射治療值集

  場景: 自動計算每次劑量
    當 我在新增放射治療
    並且 我填寫總劑量為 "6000" cGy
    並且 我填寫分次數為 "30"
    那麼 每次劑量應該自動計算為 "200" cGy

  # =============================================================================
  # 劑量計算輔助
  # =============================================================================

  @dosage-calculation
  場景: 依體表面積計算劑量
    假設 病人體重為 65.5 kg，身高為 170 cm
    當 我在新增用藥品項
    並且 我選擇劑量計算方式為 "依 BSA"
    那麼 系統應該顯示計算的 BSA 值
    當 我填寫劑量為 "175 mg/m²"
    那麼 系統應該計算並顯示實際劑量

  場景: 依體重計算劑量
    假設 病人體重為 65.5 kg
    當 我在新增用藥品項
    並且 我選擇劑量計算方式為 "依體重"
    並且 我填寫劑量為 "3 mg/kg"
    那麼 系統應該計算並顯示實際劑量為 "196.5 mg"

  # =============================================================================
  # 多筆治療資料
  # =============================================================================

  @multiple
  場景: 新增多筆用藥品項
    當 我新增以下用藥品項:
      | 藥物             | 劑量   | 頻率 |
      | IRESSA TAB 250MG | 250 mg | QD   |
      | KEYTRUDA INJ 100MG | 200 mg | Q3W |
    那麼 用藥列表應該有 2 筆記錄

  場景: 同時有用藥和放射治療
    當 案件已有用藥品項和放射治療
    那麼 治療資訊頁面應該分別顯示:
      | 區塊         | 數量 |
      | 用藥品項     | 1    |
      | 放射治療     | 1    |

  # =============================================================================
  # 編輯與刪除
  # =============================================================================

  @edit-delete
  場景: 編輯已存在的用藥品項
    假設 案件已有一筆用藥品項
    當 我點擊該用藥品項的編輯按鈕
    並且 我修改劑量為 "300"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "用藥品項已更新"

  場景: 刪除用藥品項
    假設 案件已有一筆用藥品項
    當 我點擊該用藥品項的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "用藥品項已刪除"
    並且 用藥列表應該為空

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 用藥品項必填欄位驗證
    當 我在新增用藥品項
    並且 我只填寫藥物名稱
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "劑量為必填"
    並且 我應該看到錯誤訊息包含 "頻率為必填"

  場景: 放射治療總劑量範圍驗證
    當 我在新增放射治療
    並且 我填寫總劑量為 "100000"
    那麼 我應該看到警告訊息 "總劑量異常，請確認"

  場景: 日期邏輯驗證
    當 我在新增放射治療
    並且 我填寫開始日期為 "2024-03-01"
    並且 我填寫結束日期為 "2024-02-01"
    那麼 我應該看到錯誤訊息 "結束日期不得早於開始日期"
