# language: zh-TW
@patient
功能: 病人管理
  作為一個醫療人員
  我想要能夠管理病人資料
  以便進行事前審查申報作業

  背景:
    假設 我已經登入為 "doctor01"
    並且 資料庫中存在以下病人:
      | 病歷號     | 身分證字號   | 姓名   | 性別 | 出生日期   |
      | MRN001     | A123456789   | 王小明 | 男   | 1980-01-15 |
      | MRN002     | B234567890   | 李小華 | 女   | 1975-06-20 |
      | MRN003     | C345678901   | 張大同 | 男   | 1990-12-01 |

  # =============================================================================
  # 新增病人
  # =============================================================================

  @create @happy-path
  場景: 成功新增病人資料
    當 我在病人管理頁面
    並且 我點擊 "新增病人" 按鈕
    並且 我填寫以下病人資料:
      | 欄位       | 值          |
      | 病歷號     | MRN004      |
      | 身分證字號 | D456789012  |
      | 姓名       | 陳美玲      |
      | 性別       | 女          |
      | 出生日期   | 1985-03-25  |
      | 聯絡電話   | 0912345678  |
      | 地址       | 台北市信義區 |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "病人資料已新增"
    並且 病人列表應該包含病歷號 "MRN004"
    並且 系統應該記錄新增操作至稽核日誌

  場景: 新增病人時病歷號重複
    當 我嘗試新增病歷號為 "MRN001" 的病人
    那麼 我應該看到錯誤訊息 "此病歷號已存在"

  場景: 新增病人時身分證字號格式錯誤
    當 我嘗試新增身分證字號為 "INVALID123" 的病人
    那麼 我應該看到錯誤訊息 "身分證字號格式不正確"

  場景: 新增病人缺少必填欄位
    當 我在新增病人表單
    並且 我只填寫病歷號 "MRN005"
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "姓名為必填欄位"
    並且 我應該看到錯誤訊息包含 "性別為必填欄位"
    並且 我應該看到錯誤訊息包含 "出生日期為必填欄位"

  # =============================================================================
  # 查詢病人
  # =============================================================================

  @query @happy-path
  場景: 依病歷號查詢病人
    當 我在病人管理頁面
    並且 我在搜尋欄輸入病歷號 "MRN001"
    並且 我點擊搜尋按鈕
    那麼 我應該看到病人 "王小明" 的資料
    並且 查詢結果應該只有 1 筆

  場景: 依身分證字號查詢病人
    當 我在病人管理頁面
    並且 我選擇搜尋條件為 "身分證字號"
    並且 我在搜尋欄輸入 "A123456789"
    並且 我點擊搜尋按鈕
    那麼 我應該看到病人 "王小明" 的資料

  場景: 依姓名模糊查詢病人
    當 我在病人管理頁面
    並且 我選擇搜尋條件為 "姓名"
    並且 我在搜尋欄輸入 "王"
    並且 我點擊搜尋按鈕
    那麼 查詢結果應該包含病人 "王小明"

  場景: 依性別篩選病人
    當 我在病人管理頁面
    並且 我選擇性別篩選為 "女"
    那麼 查詢結果應該只包含女性病人
    並且 查詢結果應該包含病人 "李小華"
    並且 查詢結果不應該包含病人 "王小明"

  場景: 依出生日期範圍查詢病人
    當 我在病人管理頁面
    並且 我設定出生日期範圍為 "1980-01-01" 到 "1985-12-31"
    並且 我點擊搜尋按鈕
    那麼 查詢結果應該包含病人 "王小明"
    並且 查詢結果不應該包含病人 "張大同"

  場景: 複合條件查詢病人
    當 我在病人管理頁面
    並且 我設定以下查詢條件:
      | 條件     | 值     |
      | 性別     | 男     |
      | 姓名     | 王     |
    並且 我點擊搜尋按鈕
    那麼 查詢結果應該只包含符合所有條件的病人

  場景: 查詢結果為空
    當 我在病人管理頁面
    並且 我在搜尋欄輸入病歷號 "NOTEXIST"
    並且 我點擊搜尋按鈕
    那麼 我應該看到訊息 "查無符合條件的病人"

  # =============================================================================
  # 修改病人
  # =============================================================================

  @update @happy-path
  場景: 成功修改病人資料
    當 我在病人管理頁面
    並且 我點擊病人 "王小明" 的編輯按鈕
    並且 我修改聯絡電話為 "0987654321"
    並且 我修改地址為 "新北市板橋區"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "病人資料已更新"
    並且 病人 "王小明" 的聯絡電話應該為 "0987654321"
    並且 系統應該記錄修改操作至稽核日誌

  場景: 修改病人的身分證字號
    當 我嘗試修改病人 "王小明" 的身分證字號
    那麼 身分證字號欄位應該為唯讀
    或者 我應該看到警告訊息 "身分證字號修改需經過額外驗證"

  # =============================================================================
  # 刪除病人
  # =============================================================================

  @delete
  場景: 刪除沒有關聯案件的病人
    假設 病人 "MRN003" 沒有任何關聯的申報案件
    當 我在病人管理頁面
    並且 我點擊病人 "張大同" 的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "病人資料已刪除"
    並且 病人列表不應該包含病歷號 "MRN003"

  場景: 無法刪除有關聯案件的病人
    假設 病人 "MRN001" 有關聯的申報案件
    當 我嘗試刪除病人 "王小明"
    那麼 我應該看到錯誤訊息 "無法刪除，此病人有關聯的申報案件"
    並且 病人 "王小明" 應該仍存在於系統中

  場景: 刪除操作需要確認
    當 我點擊病人 "張大同" 的刪除按鈕
    那麼 我應該看到確認對話框
    並且 對話框應該顯示 "確定要刪除病人 張大同 的資料嗎？"
    當 我點擊取消
    那麼 病人 "張大同" 應該仍存在於系統中
