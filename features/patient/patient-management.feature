# language: zh-TW
@patient
功能: 病人資料管理
  作為一個醫療人員
  我想要能夠管理病人資料
  以便進行事前審查申報作業

  背景:
    假設 我已經登入為 "doctor01"
    並且 資料庫中存在以下病人:
      | 病歷號    | 姓名     | 性別 | 生日                | 年齡 | 身分證字號   | 醫師   | 回診時間   | 到期日     |
      | 1234567   | 測試病人 | M    | 民國84年12月9日     | 30   | E125123456   |        |            |            |
      | 2345678   | 王小明   | M    | 民國70年5月15日     | 44   | A123456789   | 洪主任 | 2026-03-01 | 2026-06-01 |
      | 3456789   | 李小華   | F    | 民國65年10月20日    | 49   | B234567890   | 洪主任 | 2026-02-15 | 2026-05-15 |

  # =============================================================================
  # 病人資料管理頁面結構
  # =============================================================================

  @page-structure
  場景: 顯示病人資料管理頁面
    當 我在病人資料管理頁面
    那麼 我應該看到頁面標題 "病人資料管理"
    並且 我應該看到進階搜尋區塊
    並且 我應該看到快速搜尋欄位
    並且 我應該看到病人列表

  場景: 顯示進階搜尋欄位
    當 我在病人資料管理頁面
    那麼 進階搜尋區塊應該包含以下欄位:
      | 欄位         |
      | 病歷號       |
      | 身份證字號   |
      | 姓名         |
      | 回診時間起   |
      | 回診時間迄   |
      | 到期日起     |
      | 到期日迄     |

  場景: 顯示病人列表欄位
    當 我在病人資料管理頁面
    那麼 病人列表應該顯示以下欄位:
      | 欄位             |
      | 病歷號           |
      | 姓名             |
      | 性別             |
      | 生日             |
      | 年齡             |
      | 身分證字號       |
      | 醫師             |
      | 診間代碼及就診號 |
      | 回診時間         |
      | 回診時間(備註)   |
      | 到期日           |
      | 治療紀錄         |
      | 聯絡電話(日)     |
      | 聯絡電話(夜)     |
      | 手機號碼         |
      | 最近一筆申請案件 |

  # =============================================================================
  # 進階搜尋
  # =============================================================================

  @advanced-search
  場景: 依病歷號搜尋病人
    當 我在病人資料管理頁面
    並且 我在進階搜尋的病歷號欄位輸入 "1234567"
    並且 我點擊查詢按鈕
    那麼 我應該看到病人 "測試病人" 的資料
    並且 查詢結果應該只有 1 筆

  場景: 依身份證字號搜尋病人
    當 我在病人資料管理頁面
    並且 我在進階搜尋的身份證字號欄位輸入 "E125123456"
    並且 我點擊查詢按鈕
    那麼 我應該看到病人 "測試病人" 的資料

  場景: 依姓名搜尋病人
    當 我在病人資料管理頁面
    並且 我在進階搜尋的姓名欄位輸入 "王"
    並且 我點擊查詢按鈕
    那麼 查詢結果應該包含病人 "王小明"

  場景: 依回診時間範圍搜尋病人
    當 我在病人資料管理頁面
    並且 我設定回診時間起為 "2026-02-01"
    並且 我設定回診時間迄為 "2026-02-28"
    並且 我點擊查詢按鈕
    那麼 查詢結果應該包含回診時間在該範圍內的病人
    並且 查詢結果應該包含病人 "李小華"

  場景: 依到期日範圍搜尋病人
    當 我在病人資料管理頁面
    並且 我設定到期日起為 "2026-05-01"
    並且 我設定到期日迄為 "2026-05-31"
    並且 我點擊查詢按鈕
    那麼 查詢結果應該包含到期日在該範圍內的病人
    並且 查詢結果應該包含病人 "李小華"

  場景: 複合條件搜尋病人
    當 我在病人資料管理頁面
    並且 我設定以下搜尋條件:
      | 條件       | 值         |
      | 姓名       | 王         |
      | 回診時間起 | 2026-02-01 |
    並且 我點擊查詢按鈕
    那麼 查詢結果應該只包含符合所有條件的病人

  場景: 清除搜尋條件
    當 我在病人資料管理頁面
    並且 我已設定多個搜尋條件
    並且 我點擊 "清除" 按鈕
    那麼 所有搜尋條件應該被清除

  # =============================================================================
  # 快速搜尋
  # =============================================================================

  @quick-search
  場景: 使用快速搜尋
    當 我在病人資料管理頁面
    並且 我在快速搜尋欄位輸入 "測試病人"
    那麼 病人列表應該即時篩選顯示符合條件的病人

  場景: 快速搜尋支援多欄位
    當 我在病人資料管理頁面
    並且 我在快速搜尋欄位輸入 "1234567"
    那麼 病人列表應該顯示病歷號包含 "1234567" 的病人

  # =============================================================================
  # 查看與編輯病人
  # =============================================================================

  @edit
  場景: 編輯病人資料
    當 我在病人資料管理頁面
    並且 我點擊病人 "測試病人" 的 "編輯" 按鈕
    那麼 我應該看到病人資料編輯表單

  場景: 修改病人聯絡資訊
    當 我在病人 "測試病人" 的編輯表單
    並且 我修改聯絡電話(日)為 "02-12345678"
    並且 我修改手機號碼為 "0912345678"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "病人資料已更新"

  場景: 修改病人回診時間
    當 我在病人 "測試病人" 的編輯表單
    並且 我修改回診時間為 "2026-04-01"
    並且 我點擊儲存按鈕
    那麼 病人的回診時間應該更新為 "2026-04-01"

  場景: 身分證字號欄位為唯讀
    當 我在病人 "測試病人" 的編輯表單
    那麼 身分證字號欄位應該為唯讀
    或者 修改身分證字號應該需要額外驗證

  # =============================================================================
  # 查看病人申請案件歷史
  # =============================================================================

  @case-history
  場景: 查看病人的申請案件歷史
    當 我在病人資料管理頁面
    並且 我點擊病人 "測試病人" 的 "更多" 按鈕
    那麼 我應該被導向申請表歷史記錄頁面
    並且 頁面應該顯示病人基本資訊:
      | 資訊       | 值           |
      | 病歷號     | 1234567      |
      | 姓名       | 測試病人     |
      | 身分證     | E125123456   |

  場景: 申請案件歷史列表欄位
    當 我在病人 "測試病人" 的申請表歷史記錄頁面
    那麼 案件列表應該顯示以下欄位:
      | 欄位         |
      | 申請類別     |
      | 申請次數     |
      | 疾病別       |
      | 申請藥品     |
      | 申請日期     |
      | 影像學檢查   |
      | 送審日期     |
      | 通過日期     |
      | 續件日期     |
      | 未通過日期   |
      | 備註         |
      | 狀態         |

  場景: 從歷史記錄編輯草稿案件
    假設 病人 "測試病人" 有一個草稿狀態的案件
    當 我在該病人的申請表歷史記錄頁面
    並且 我點擊該草稿案件的 "編輯" 按鈕
    那麼 我應該被導向該案件的編輯頁面

  場景: 從歷史記錄返回病人列表
    當 我在病人 "測試病人" 的申請表歷史記錄頁面
    並且 我點擊 "返回" 按鈕
    那麼 我應該被導向病人資料管理頁面

  # =============================================================================
  # 身分證字號驗證
  # =============================================================================

  @validation
  場景: 身分證字號格式驗證
    當 我在病人資料管理頁面
    並且 我在身份證字號欄位輸入 "INVALID"
    那麼 我應該看到提示訊息 "請填身分證字號共十碼(前一碼為大寫英文字母)"

  場景: 身分證字號長度驗證
    當 我在病人資料管理頁面
    並且 我在身份證字號欄位輸入 "A12345"
    那麼 我應該看到驗證錯誤訊息

  # =============================================================================
  # 查詢無結果
  # =============================================================================

  @no-results
  場景: 查詢結果為空
    當 我在病人資料管理頁面
    並且 我在病歷號欄位輸入 "NOTEXIST"
    並且 我點擊查詢按鈕
    那麼 病人列表應該為空

  # =============================================================================
  # 分頁
  # =============================================================================

  @pagination
  場景: 顯示分頁控制
    假設 資料庫中存在超過一頁的病人資料
    當 我在病人資料管理頁面
    那麼 我應該看到分頁控制項

  場景: 切換分頁
    假設 資料庫中存在超過一頁的病人資料
    當 我在病人資料管理頁面
    並且 我點擊第 2 頁
    那麼 應該顯示第二頁的病人資料

  # =============================================================================
  # 最近一筆申請案件
  # =============================================================================

  @recent-case
  場景: 顯示最近一筆申請案件
    假設 病人 "測試病人" 有申請案件
    當 我在病人資料管理頁面
    那麼 病人列表中 "測試病人" 的 "最近一筆申請案件" 欄位應該顯示案件資訊

  場景: 點擊最近一筆申請案件
    假設 病人 "測試病人" 有申請案件
    當 我在病人資料管理頁面
    並且 我點擊病人 "測試病人" 的最近一筆申請案件連結
    那麼 我應該被導向該案件的詳情頁面
