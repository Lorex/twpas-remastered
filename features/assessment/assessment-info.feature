# language: zh-TW
@assessment
功能: 評估資訊管理
  作為一個醫療人員
  我想要能夠填寫申報案件的評估資訊
  以便記錄檢驗檢查結果和病人狀態評估

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 我在案件 "CASE-001" 的評估資訊頁面

  # =============================================================================
  # 檢驗檢查
  # =============================================================================

  @lab-tests @happy-path
  場景: 新增檢驗檢查結果
    當 我點擊 "新增檢驗檢查" 按鈕
    並且 我填寫以下檢驗資料:
      | 欄位         | 值                    |
      | 檢驗項目     | CEA (癌胚抗原)        |
      | LOINC 代碼   | 2039-6                |
      | 數值         | 15.5                  |
      | 單位         | ng/mL                 |
      | 參考值上限   | 5.0                   |
      | 參考值下限   | 0.0                   |
      | 檢驗日期     | 2024-02-01            |
      | 判讀結果     | 異常 (高)             |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "檢驗檢查已新增"
    並且 檢驗檢查列表應該包含 "CEA (癌胚抗原)"

  場景: 搜尋並選擇檢驗項目
    當 我在新增檢驗檢查
    並且 我在檢驗項目欄位輸入 "CEA"
    那麼 我應該看到檢驗項目搜尋結果
    並且 結果應該包含 "CEA (癌胚抗原) - 2039-6"
    當 我選擇 "CEA (癌胚抗原)"
    那麼 檢驗項目欄位應該顯示 "CEA (癌胚抗原)"
    並且 LOINC 代碼應該自動填入 "2039-6"

  場景大綱: 常見腫瘤標記檢驗項目
    當 我在新增檢驗檢查
    並且 我選擇檢驗項目為 "<檢驗項目>"
    那麼 LOINC 代碼應該自動填入 "<LOINC>"

    例子:
      | 檢驗項目           | LOINC    |
      | CEA (癌胚抗原)     | 2039-6   |
      | AFP (甲型胎兒蛋白) | 1834-1   |
      | CA-125             | 10334-1  |
      | CA 19-9            | 24108-3  |
      | PSA (攝護腺特異抗原)| 2857-1  |

  場景: 檢驗結果數值範圍標示
    假設 案件已有檢驗項目 "CEA" 數值為 "15.5"
    並且 該檢驗項目參考值範圍為 "0.0 - 5.0" ng/mL
    當 我在評估資訊頁面
    那麼 該檢驗結果應該標示為 "異常 (高)"
    並且 應該以紅色標示該數值

  場景: 檢驗結果正常範圍
    假設 案件已有檢驗項目 "CEA" 數值為 "3.0"
    並且 該檢驗項目參考值範圍為 "0.0 - 5.0" ng/mL
    當 我在評估資訊頁面
    那麼 該檢驗結果應該標示為 "正常"
    並且 應該以綠色標示該數值

  # =============================================================================
  # 病人狀態評估
  # =============================================================================

  @patient-assessment @happy-path
  場景: 新增病人狀態評估 - ECOG
    當 我點擊 "新增病人狀態評估" 按鈕
    並且 我填寫以下評估資料:
      | 欄位         | 值                    |
      | 評估項目     | ECOG 體能狀態         |
      | 評估日期     | 2024-02-01            |
      | 分數         | 1                     |
      | 說明         | 可行走，能進行輕度活動 |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "病人狀態評估已新增"
    並且 評估列表應該包含 "ECOG 體能狀態"

  場景大綱: ECOG 體能狀態評分
    當 我在新增病人狀態評估
    並且 我選擇評估項目為 "ECOG 體能狀態"
    並且 我選擇分數為 "<分數>"
    那麼 說明欄位應該顯示 "<說明>"

    例子:
      | 分數 | 說明                                     |
      | 0    | 完全正常活動，無任何症狀                 |
      | 1    | 可行走，能進行輕度活動                   |
      | 2    | 可行走，能自理，但無法工作，醒著時間臥床<50% |
      | 3    | 僅能有限自理，醒著時間臥床>50%           |
      | 4    | 完全失能，無法自理，全天臥床             |
      | 5    | 死亡                                     |

  場景: 新增病人狀態評估 - Karnofsky
    當 我點擊 "新增病人狀態評估" 按鈕
    並且 我選擇評估項目為 "Karnofsky 體能狀態"
    並且 我選擇分數為 "80"
    那麼 說明欄位應該顯示 "正常活動但有些吃力，有一些疾病徵兆"

  場景大綱: Karnofsky 體能狀態評分
    當 我在新增病人狀態評估
    並且 我選擇評估項目為 "Karnofsky 體能狀態"
    並且 我選擇分數為 "<分數>"
    那麼 說明欄位應該顯示 "<說明>"

    例子:
      | 分數 | 說明                                     |
      | 100  | 正常，無症狀                             |
      | 90   | 能進行正常活動，輕微症狀                 |
      | 80   | 正常活動但有些吃力，有一些疾病徵兆       |
      | 70   | 能自理，但無法工作或正常活動             |
      | 60   | 偶爾需要協助，但能照顧大部分需求         |
      | 50   | 需要相當多的協助和頻繁的醫療照護         |
      | 40   | 失能，需要特殊照護和協助                 |
      | 30   | 嚴重失能，需住院但無立即死亡危險         |
      | 20   | 非常虛弱，需要積極的支持性治療           |
      | 10   | 瀕死                                     |
      | 0    | 死亡                                     |

  場景: 新增病人狀態評估 - Child-Pugh
    當 我點擊 "新增病人狀態評估" 按鈕
    並且 我選擇評估項目為 "Child-Pugh 分級"
    並且 我填寫以下評估項目:
      | 項目         | 分數 |
      | 腹水         | 1    |
      | 肝性腦病變   | 1    |
      | 膽紅素       | 1    |
      | 白蛋白       | 2    |
      | PT 延長      | 1    |
    那麼 總分應該自動計算為 "6"
    並且 分級應該顯示為 "Child-Pugh A"

  場景: 新增病人狀態評估 - MELD
    當 我點擊 "新增病人狀態評估" 按鈕
    並且 我選擇評估項目為 "MELD 分數"
    並且 我填寫以下數值:
      | 項目         | 值   |
      | 肌酸酐       | 1.2  |
      | 膽紅素       | 2.0  |
      | INR          | 1.3  |
    那麼 MELD 分數應該自動計算
    並且 計算結果應該顯示

  # =============================================================================
  # C90/C92 診斷特殊需求
  # =============================================================================

  @c90-c92 @required
  場景: C90/C92 診斷需提供檢驗檢查
    假設 案件的診斷代碼為 "C90.0" (多發性骨髓瘤)
    當 我在評估資訊頁面
    那麼 我應該看到提醒訊息 "C90/C92 診斷需提供檢驗檢查資料"

  場景: C90 診斷必要檢驗項目
    假設 案件的診斷代碼為 "C90.0" (多發性骨髓瘤)
    當 我在評估資訊頁面
    那麼 系統應該建議以下檢驗項目:
      | 檢驗項目                  |
      | 血清蛋白電泳              |
      | 尿液蛋白電泳              |
      | 免疫固定電泳              |
      | 骨髓穿刺/活檢             |
      | β2-微球蛋白              |

  場景: C92 診斷必要檢驗項目
    假設 案件的診斷代碼為 "C92.0" (急性骨髓性白血病)
    當 我在評估資訊頁面
    那麼 系統應該建議以下檢驗項目:
      | 檢驗項目                  |
      | 血液常規 (CBC)            |
      | 骨髓穿刺/活檢             |
      | 細胞遺傳學分析            |
      | 分子基因檢測              |

  # =============================================================================
  # 多筆評估資料
  # =============================================================================

  @multiple
  場景: 新增多筆檢驗檢查
    當 我新增以下檢驗檢查:
      | 檢驗項目           | 數值 | 單位   |
      | CEA (癌胚抗原)     | 15.5 | ng/mL  |
      | CA-125             | 45.0 | U/mL   |
      | AFP (甲型胎兒蛋白) | 8.2  | ng/mL  |
    那麼 檢驗檢查列表應該有 3 筆記錄

  場景: 同時有檢驗檢查和病人狀態評估
    當 案件已有檢驗檢查和病人狀態評估
    那麼 評估資訊頁面應該分別顯示:
      | 區塊           | 數量 |
      | 檢驗檢查       | 2    |
      | 病人狀態評估   | 1    |

  # =============================================================================
  # 編輯與刪除
  # =============================================================================

  @edit-delete
  場景: 編輯已存在的檢驗結果
    假設 案件已有一筆 "CEA" 檢驗結果
    當 我點擊該檢驗結果的編輯按鈕
    並且 我修改數值為 "12.0"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "檢驗檢查已更新"

  場景: 刪除檢驗結果
    假設 案件已有一筆檢驗結果
    當 我點擊該檢驗結果的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "檢驗檢查已刪除"
    並且 檢驗檢查列表應該為空

  場景: 編輯病人狀態評估
    假設 案件已有一筆 "ECOG" 評估
    當 我點擊該評估的編輯按鈕
    並且 我修改分數為 "2"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "病人狀態評估已更新"

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 檢驗結果必填欄位驗證
    當 我在新增檢驗檢查
    並且 我只填寫檢驗項目
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "數值為必填"
    並且 我應該看到錯誤訊息包含 "檢驗日期為必填"

  場景: 檢驗日期不得在未來
    當 我在新增檢驗檢查
    並且 我填寫檢驗日期為明天的日期
    那麼 我應該看到錯誤訊息 "檢驗日期不得為未來日期"

  場景: 評估日期不得在未來
    當 我在新增病人狀態評估
    並且 我填寫評估日期為明天的日期
    那麼 我應該看到錯誤訊息 "評估日期不得為未來日期"

  # =============================================================================
  # 趨勢分析
  # =============================================================================

  @trend
  場景: 顯示檢驗結果趨勢
    假設 案件有多筆相同檢驗項目的歷史記錄:
      | 檢驗日期   | 數值 |
      | 2024-01-01 | 20.0 |
      | 2024-01-15 | 18.5 |
      | 2024-02-01 | 15.5 |
    當 我在評估資訊頁面
    並且 我點擊 "CEA" 檢驗項目的趨勢圖標
    那麼 我應該看到趨勢圖表
    並且 圖表應該顯示數值下降趨勢

  場景: ECOG 狀態變化追蹤
    假設 案件有多筆 ECOG 評估記錄:
      | 評估日期   | 分數 |
      | 2024-01-01 | 0    |
      | 2024-01-15 | 1    |
      | 2024-02-01 | 1    |
    當 我在評估資訊頁面
    那麼 我應該看到 ECOG 狀態變化記錄
    並且 最新評估應該標示為目前狀態
