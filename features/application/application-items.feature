# language: zh-TW
@application-items
功能: 申請項目管理
  作為一個醫療人員
  我想要能夠管理申報案件的申請項目
  以便記錄需要事前審查的藥品或醫療項目

  背景:
    假設 我已經登入為 "doctor01"
    並且 存在草稿狀態的申報案件 "CASE-001"
    並且 我在案件 "CASE-001" 的申請項目頁面

  # =============================================================================
  # 新增申請項目
  # =============================================================================

  @add-item @happy-path
  場景: 新增標靶藥物申請項目
    當 我點擊 "新增申請項目" 按鈕
    並且 我填寫以下申請項目資料:
      | 欄位         | 值                    |
      | 醫令類別     | 標靶治療              |
      | 藥物         | IRESSA TAB 250MG      |
      | 健保碼       | KC00961100            |
      | 申請數量     | 30                    |
      | 單位         | TAB                   |
      | 申請天數     | 30                    |
      | 適應症說明   | EGFR 突變陽性非小細胞肺癌 |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "申請項目已新增"
    並且 申請項目列表應該包含 "IRESSA TAB 250MG"

  場景: 新增免疫治療申請項目
    當 我點擊 "新增申請項目" 按鈕
    並且 我填寫以下申請項目資料:
      | 欄位         | 值                    |
      | 醫令類別     | 免疫治療              |
      | 藥物         | KEYTRUDA INJ 100MG    |
      | 健保碼       | KC01234100            |
      | 申請數量     | 2                     |
      | 單位         | VIAL                  |
      | 申請天數     | 21                    |
      | 適應症說明   | PD-L1 ≥50% 非小細胞肺癌 |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "申請項目已新增"

  場景大綱: 醫令類別選擇
    當 我在新增申請項目
    並且 我選擇醫令類別為 "<類別>"
    那麼 醫令類別欄位應該顯示 "<類別>"

    例子:
      | 類別         |
      | 標靶治療     |
      | 免疫治療     |
      | 化學治療     |
      | 荷爾蒙治療   |
      | 其他         |

  # =============================================================================
  # 藥物搜尋與選擇
  # =============================================================================

  @drug-search
  場景: 依健保碼搜尋藥物
    當 我在新增申請項目
    並且 我在藥物欄位輸入健保碼 "KC00961100"
    那麼 我應該看到搜尋結果包含 "IRESSA TAB 250MG"
    當 我選擇該藥物
    那麼 健保碼欄位應該自動填入 "KC00961100"
    並且 ATC 代碼應該顯示 "L01EB01"

  場景: 依藥物名稱搜尋
    當 我在新增申請項目
    並且 我在藥物欄位輸入 "IRESSA"
    那麼 我應該看到藥物搜尋結果
    並且 結果應該包含 "IRESSA TAB 250MG (KC00961100)"

  場景: 依 ATC 代碼搜尋
    當 我在新增申請項目
    並且 我在藥物欄位輸入 ATC 代碼 "L01EB01"
    那麼 我應該看到所有 ATC 代碼為 "L01EB01" 的藥物

  場景: 顯示藥物詳細資訊
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    那麼 我應該看到藥物詳細資訊:
      | 欄位         | 值              |
      | 健保碼       | KC00961100      |
      | 學名         | GEFITINIB       |
      | ATC 代碼     | L01EB01         |
      | 包裝規格     | 30 TAB/BOX      |

  # =============================================================================
  # 適應症驗證
  # =============================================================================

  @indication-validation
  場景: 藥物適應症提示
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    那麼 系統應該顯示該藥物的核准適應症:
      | 適應症                                         |
      | 具有EGFR突變之局部晚期或轉移性非小細胞肺癌     |

  場景: 適應症符合驗證
    假設 案件的基因檢測結果為 "EGFR L858R 突變陽性"
    並且 案件的診斷為 "非小細胞肺癌"
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    那麼 系統應該顯示 "適應症符合" 提示

  場景: 適應症可能不符警告
    假設 案件沒有基因檢測結果
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    那麼 系統應該顯示警告 "此藥物需要 EGFR 突變檢測結果"

  # =============================================================================
  # 數量與天數
  # =============================================================================

  @quantity-calculation
  場景: 依劑量計算申請數量
    假設 案件已設定用藥品項 "IRESSA TAB 250MG" 劑量 "250 mg QD"
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    並且 我填寫申請天數為 "30"
    那麼 申請數量應該自動計算為 "30" TAB

  場景: 手動調整申請數量
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    並且 我手動填寫申請數量為 "60"
    那麼 申請數量欄位應該顯示 "60"
    並且 系統應該顯示提示 "與建議數量 30 TAB 不同"

  場景: 申請天數限制提醒
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    並且 我填寫申請天數為 "90"
    那麼 系統應該顯示提醒 "超過建議申請天數 28-30 天"

  # =============================================================================
  # 多筆申請項目
  # =============================================================================

  @multiple-items
  場景: 新增多筆申請項目
    當 我新增以下申請項目:
      | 藥物                 | 數量 | 單位 |
      | IRESSA TAB 250MG     | 30   | TAB  |
      | AVASTIN INJ 100MG    | 4    | VIAL |
    那麼 申請項目列表應該有 2 筆記錄

  場景: 計算申請項目總費用預估
    假設 案件已有以下申請項目:
      | 藥物                 | 數量 | 單價      |
      | IRESSA TAB 250MG     | 30   | 3000      |
      | KEYTRUDA INJ 100MG   | 2    | 150000    |
    當 我在申請項目頁面
    那麼 應該顯示預估總費用為 "390,000" 元

  場景: 調整申請項目順序
    假設 案件已有多筆申請項目
    當 我拖曳第二筆申請項目到第一順位
    那麼 申請項目順序應該更新
    並且 應該顯示成功訊息 "順序已更新"

  # =============================================================================
  # 編輯與刪除
  # =============================================================================

  @edit-delete
  場景: 編輯已存在的申請項目
    假設 案件已有一筆申請項目 "IRESSA TAB 250MG"
    當 我點擊該申請項目的編輯按鈕
    並且 我修改申請數量為 "60"
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "申請項目已更新"
    並且 申請項目的數量應該顯示為 "60"

  場景: 刪除申請項目
    假設 案件已有一筆申請項目
    當 我點擊該申請項目的刪除按鈕
    並且 我確認刪除操作
    那麼 我應該看到成功訊息 "申請項目已刪除"
    並且 申請項目列表應該為空

  場景: 複製申請項目
    假設 案件已有一筆申請項目 "IRESSA TAB 250MG"
    當 我點擊該申請項目的複製按鈕
    那麼 系統應該建立一筆相同的申請項目
    並且 申請項目列表應該有 2 筆記錄

  # =============================================================================
  # 驗證規則
  # =============================================================================

  @validation
  場景: 申請項目必填欄位驗證
    當 我在新增申請項目
    並且 我只填寫藥物名稱
    並且 我點擊儲存按鈕
    那麼 我應該看到錯誤訊息包含 "申請數量為必填"
    並且 我應該看到錯誤訊息包含 "申請天數為必填"

  場景: 申請數量須為正整數
    當 我在新增申請項目
    並且 我填寫申請數量為 "-5"
    那麼 我應該看到錯誤訊息 "申請數量須為正整數"

  場景: 重複藥物警告
    假設 案件已有申請項目 "IRESSA TAB 250MG"
    當 我在新增申請項目
    並且 我選擇藥物 "IRESSA TAB 250MG"
    那麼 系統應該顯示警告 "此藥物已存在於申請項目中"

  # =============================================================================
  # 從治療資訊帶入
  # =============================================================================

  @import-from-treatment
  場景: 從用藥品項自動帶入申請項目
    假設 案件已設定用藥品項:
      | 藥物             | 劑量   | 頻率 |
      | IRESSA TAB 250MG | 250 mg | QD   |
    當 我在申請項目頁面
    並且 我點擊 "從治療資訊帶入" 按鈕
    那麼 系統應該詢問是否帶入用藥品項作為申請項目
    當 我確認帶入
    那麼 申請項目列表應該包含 "IRESSA TAB 250MG"
    並且 申請數量應該根據劑量和頻率自動計算

  場景: 選擇性帶入用藥品項
    假設 案件已設定多筆用藥品項
    當 我在申請項目頁面
    並且 我點擊 "從治療資訊帶入" 按鈕
    那麼 我應該看到用藥品項選擇清單
    當 我勾選要帶入的項目
    並且 我點擊確認
    那麼 只有被選取的項目應該被帶入申請項目

  # =============================================================================
  # 續用申請特殊處理
  # =============================================================================

  @continuation
  場景: 續用申請帶入前次核准項目
    假設 案件的申報類別為 "續用申請"
    並且 存在前次核准案件
    當 我在申請項目頁面
    那麼 系統應該顯示 "帶入前次核准項目" 按鈕
    當 我點擊該按鈕
    那麼 前次核准的申請項目應該被帶入

  場景: 續用申請顯示前次核准資訊
    假設 案件的申報類別為 "續用申請"
    並且 申請項目來自前次核准
    當 我在申請項目頁面
    那麼 應該顯示前次核准資訊:
      | 資訊         |
      | 核准日期     |
      | 核准數量     |
      | 核准效期     |

  # =============================================================================
  # 療程變更申請
  # =============================================================================

  @regimen-change
  場景: 療程變更申請需說明變更原因
    假設 案件的申報類別為 "療程變更"
    當 我在新增申請項目
    那麼 系統應該要求填寫變更原因
    並且 應該顯示變更原因選項:
      | 原因             |
      | 療效不佳         |
      | 產生抗藥性       |
      | 無法耐受副作用   |
      | 疾病惡化         |
      | 其他             |

  場景: 療程變更申請顯示前次用藥
    假設 案件的申報類別為 "療程變更"
    當 我在申請項目頁面
    那麼 系統應該顯示前次用藥資訊供參考
    並且 應該標示此次申請與前次的差異

  # =============================================================================
  # 匯出與預覽
  # =============================================================================

  @export-preview
  場景: 預覽申請項目清單
    假設 案件已有多筆申請項目
    當 我點擊 "預覽清單" 按鈕
    那麼 我應該看到申請項目清單預覽
    並且 清單應該包含:
      | 欄位         |
      | 項次         |
      | 藥物名稱     |
      | 健保碼       |
      | 數量         |
      | 單位         |
      | 申請天數     |
      | 預估費用     |

  場景: 匯出申請項目為 PDF
    假設 案件已有多筆申請項目
    當 我點擊 "匯出 PDF" 按鈕
    那麼 系統應該產生並下載申請項目清單 PDF
