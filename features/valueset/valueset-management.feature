# language: zh-TW
@valueset
功能: 值集管理
  作為一個系統管理員
  我想要能夠管理系統使用的值集與代碼系統
  以便確保申報資料符合健保署規範

  背景:
    假設 我已經登入為 "admin01"
    並且 系統已載入以下值集:
      | 識別碼                                                    | 名稱           |
      | https://nhicore.nhi.gov.tw/pas/ValueSet/nhi-apply-type   | NHI-申報類別   |
      | https://nhicore.nhi.gov.tw/pas/ValueSet/nhi-tmhb-type    | NHI-案件類別   |
      | https://nhicore.nhi.gov.tw/pas/ValueSet/nhi-medication   | NHI-用藥品項   |

  # =============================================================================
  # 值集查詢
  # =============================================================================

  @query
  場景: 查看所有值集列表
    當 我在值集管理頁面
    那麼 我應該看到值集列表
    並且 列表應該包含 "NHI-申報類別"
    並且 列表應該包含 "NHI-案件類別"
    並且 列表應該包含 "NHI-用藥品項"

  場景: 依名稱搜尋值集
    當 我在值集管理頁面
    並且 我在搜尋欄輸入 "申報"
    那麼 我應該看到 "NHI-申報類別" 值集
    並且 結果不應該包含 "NHI-用藥品項"

  場景: 依識別碼搜尋值集
    當 我在值集管理頁面
    並且 我在搜尋欄輸入 "nhi-apply-type"
    那麼 我應該看到 "NHI-申報類別" 值集

  場景: 查看值集詳情
    當 我點擊 "NHI-申報類別" 值集
    那麼 我應該看到值集詳情頁面
    並且 頁面應該顯示:
      | 項目       |
      | 識別碼     |
      | 名稱       |
      | 版本       |
      | 狀態       |
      | 說明       |
      | 代碼列表   |

  場景: 查看值集的代碼列表
    當 我點擊 "NHI-申報類別" 值集
    那麼 我應該看到以下代碼:
      | 代碼 | 顯示名稱   |
      | 1    | 新申請     |
      | 2    | 補件       |
      | 3    | 申覆       |
      | 4    | 爭議審議   |
      | 5    | 申覆補件   |

  # =============================================================================
  # 值集代碼搜尋
  # =============================================================================

  @code-search
  場景: 依代碼搜尋
    當 我在 "NHI-用藥品項" 值集頁面
    並且 我在代碼搜尋欄輸入 "KC00"
    那麼 我應該看到代碼以 "KC00" 開頭的藥品

  場景: 依顯示名稱搜尋
    當 我在 "NHI-用藥品項" 值集頁面
    並且 我選擇搜尋條件為 "顯示名稱"
    並且 我輸入 "GEFITINIB"
    那麼 我應該看到含有 "GEFITINIB" 的藥品

  場景: 搜尋無結果
    當 我在 "NHI-用藥品項" 值集頁面
    並且 我搜尋 "NOTEXISTDRUG"
    那麼 我應該看到訊息 "查無符合條件的代碼"

  # =============================================================================
  # 代碼系統管理
  # =============================================================================

  @code-system
  場景: 查看代碼系統列表
    當 我在代碼系統頁面
    那麼 我應該看到代碼系統列表
    並且 列表應該包含以下系統:
      | 名稱                   |
      | NHI 申報類別           |
      | NHI 案件類別           |
      | NHI 用藥品項           |
      | LOINC                  |
      | ICD-10-PCS             |
      | SNOMED CT              |

  場景: 查看代碼系統詳情
    當 我點擊 "NHI 申報類別" 代碼系統
    那麼 我應該看到代碼系統詳情頁面
    並且 頁面應該顯示所有代碼

  場景: 依代碼搜尋代碼系統中的代碼
    當 我在代碼系統 "ICD-10-PCS" 頁面
    並且 我搜尋代碼 "BW230"
    那麼 我應該看到相關的 CT 檢查代碼

  # =============================================================================
  # 值集 CRUD
  # =============================================================================

  @crud
  場景: 新增自訂值集
    當 我在值集管理頁面
    並且 我點擊 "新增值集" 按鈕
    並且 我填寫以下值集資料:
      | 欄位       | 值                   |
      | 識別碼     | custom-test-valueset |
      | 名稱       | 測試值集             |
      | 版本       | 1.0.0                |
      | 說明       | 用於測試的自訂值集   |
    並且 我點擊儲存按鈕
    那麼 我應該看到成功訊息 "值集已新增"

  場景: 新增代碼到值集
    假設 存在自訂值集 "custom-test-valueset"
    當 我在該值集的詳情頁面
    並且 我點擊 "新增代碼" 按鈕
    並且 我填寫以下代碼資料:
      | 欄位       | 值           |
      | 代碼       | TEST001      |
      | 顯示名稱   | 測試代碼一   |
      | 定義       | 用於測試     |
    並且 我點擊儲存按鈕
    那麼 值集應該包含代碼 "TEST001"

  場景: 修改代碼顯示名稱
    假設 存在代碼 "TEST001" 在自訂值集中
    當 我編輯該代碼
    並且 我修改顯示名稱為 "更新後的名稱"
    並且 我點擊儲存按鈕
    那麼 代碼的顯示名稱應該為 "更新後的名稱"

  場景: 刪除自訂值集中的代碼
    假設 存在代碼 "TEST001" 在自訂值集中
    當 我刪除該代碼
    並且 我確認刪除操作
    那麼 值集不應該包含代碼 "TEST001"

  場景: 無法刪除系統值集
    當 我嘗試刪除 "NHI-申報類別" 值集
    那麼 刪除按鈕應該被停用
    或者 我應該看到錯誤訊息 "系統值集無法刪除"

  場景: 無法修改系統值集的代碼
    當 我嘗試編輯 "NHI-申報類別" 值集的代碼
    那麼 編輯按鈕應該被停用
    或者 我應該看到訊息 "系統值集的代碼為唯讀"

  # =============================================================================
  # 值集 API (供前端選單使用)
  # =============================================================================

  @api
  場景: API 取得申報類別選項
    當 我呼叫 GET /api/valuesets/apply-type
    那麼 回應應該包含以下選項:
      | code | display    |
      | 1    | 新申請     |
      | 2    | 補件       |
      | 3    | 申覆       |
      | 4    | 爭議審議   |
      | 5    | 申覆補件   |

  場景: API 取得案件類別選項
    當 我呼叫 GET /api/valuesets/case-type
    那麼 回應應該包含以下選項:
      | code | display      |
      | 1    | 一般事前審查 |
      | 3    | 自主審查     |
      | 4    | 緊急報備     |

  場景: API 搜尋用藥品項
    當 我呼叫 GET /api/valuesets/medication?search=GEFITINIB&limit=10
    那麼 回應應該包含符合條件的藥品選項
    並且 回應筆數不超過 10 筆

  場景: API 驗證代碼有效性
    當 我呼叫 GET /api/valuesets/apply-type/validate/1
    那麼 回應應該為:
      | valid | display  |
      | true  | 新申請   |

  場景: API 驗證無效代碼
    當 我呼叫 GET /api/valuesets/apply-type/validate/99
    那麼 回應應該為:
      | valid |
      | false |

  # =============================================================================
  # 值集同步
  # =============================================================================

  @sync
  場景: 從 FHIR IG 同步值集
    當 我點擊 "同步值集" 按鈕
    那麼 系統應該從 FHIR IG 載入最新的值集
    並且 應該顯示同步結果:
      | 項目       |
      | 更新數量   |
      | 新增數量   |
      | 失敗數量   |

  場景: 值集快取刷新
    當 我點擊 "刷新快取" 按鈕
    那麼 系統應該清除並重新載入所有值集快取
    並且 應該顯示成功訊息 "快取已刷新"

  場景: 顯示值集最後更新時間
    當 我在值集詳情頁面
    那麼 我應該看到 "最後更新時間" 資訊
